<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Adam System Atlas v41</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #030508;
            font-family: 'IBM Plex Mono', monospace;
            color: #dce8f5;
            -webkit-font-smoothing: antialiased;
        }

        body {
            display: flex;
        }

        #viewport {
            flex: 1;
            height: 100vh;
            position: relative;
            cursor: grab;
            touch-action: none;
            background: radial-gradient(ellipse at 50% 40%, #0a1220 0%, #030508 70%);
            min-width: 0;
        }

        #viewport:active {
            cursor: grabbing;
        }

        #viewport::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0, 229, 255, 0.005) 2px, rgba(0, 229, 255, 0.005) 4px);
            pointer-events: none;
            z-index: 5;
        }

        .vp-label {
            position: absolute;
            font-size: 9px;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            color: #5a6a7e;
            font-weight: 500;
            z-index: 10;
            pointer-events: none;
        }

        #vp-tl {
            top: 16px;
            left: 16px;
        }

        #vp-bl {
            bottom: 16px;
            left: 16px;
        }

        .vp-btn {
            position: absolute;
            top: 16px;
            z-index: 10;
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.06);
            color: #5a6a7e;
            padding: 8px 14px;
            cursor: pointer;
            font-size: 9px;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            border-radius: 6px;
            font-family: inherit;
            transition: border-color 0.2s, color 0.2s;
        }

        .vp-btn:hover {
            border-color: #00e5ff;
            color: #00e5ff;
        }

        #reset-view {
            right: 16px;
        }

        #shell-toggle {
            right: 110px;
        }

        #shell-toggle.state-on {
            border-color: rgba(0, 229, 255, 0.4);
            color: #00e5ff;
        }

        #shell-toggle.state-dim {
            border-color: rgba(0, 229, 255, 0.2);
            color: #3a5a6e;
        }

        #stl-drop-overlay {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 229, 255, 0.08);
            border: 3px dashed rgba(0, 229, 255, 0.5);
            z-index: 50;
            pointer-events: none;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #00e5ff;
            letter-spacing: 2px;
            text-transform: uppercase;
            font-weight: 600;
        }

        #stl-drop-overlay.show {
            display: flex;
        }

        #stl-file-input {
            display: none;
        }


        /* HUD */
        #hud {
            width: 380px;
            min-width: 340px;
            height: 100vh;
            background: rgba(8, 12, 18, 0.97);
            border-left: 1px solid rgba(255, 255, 255, 0.06);
            display: flex;
            flex-direction: column;
            z-index: 100;
            box-shadow: -30px 0 80px rgba(0, 0, 0, 0.5);
        }

        #hud-header {
            padding: 14px 18px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            background: rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        #hud-header h1 {
            font-size: 12px;
            font-weight: 600;
            color: #00e5ff;
            letter-spacing: 3px;
            text-transform: uppercase;
            margin: 0;
        }

        #active-count {
            font-size: 10px;
            color: #5a6a7e;
            font-weight: 500;
            letter-spacing: 1px;
        }

        .scroll-zone {
            padding: 14px 18px;
            overflow-y: auto;
            flex-grow: 1;
            scrollbar-width: thin;
            scrollbar-color: #1a2535 transparent;
        }

        .scroll-zone::-webkit-scrollbar {
            width: 3px;
        }

        .scroll-zone::-webkit-scrollbar-thumb {
            background: #1a2535;
            border-radius: 3px;
        }

        .section-label {
            font-size: 9px;
            color: #3a4656;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 600;
            margin: 18px 0 8px 0;
            padding-bottom: 5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }

        .section-label:first-child {
            margin-top: 0;
        }

        /* Search */
        #search-input {
            width: 100%;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.06);
            color: #dce8f5;
            padding: 10px 12px;
            font-family: inherit;
            font-size: 11px;
            border-radius: 6px;
            outline: none;
        }

        #search-input:focus {
            border-color: #00e5ff;
        }

        #search-input::placeholder {
            color: #3a4656;
        }

        #alter-dropdown {
            display: none;
            background: rgba(8, 14, 24, 0.98);
            border: 1px solid rgba(0, 229, 255, 0.3);
            border-radius: 6px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 4px;
            margin-bottom: 8px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
        }

        #alter-dropdown.show {
            display: block;
        }

        .dd-item {
            padding: 8px 12px;
            font-size: 11px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.02);
        }

        .dd-item:hover {
            background: rgba(0, 229, 255, 0.08);
        }

        .dd-item.used {
            opacity: 0.3;
            pointer-events: none;
        }

        .dd-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .dd-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
            display: inline-block;
        }

        .dd-weight {
            font-size: 9px;
            color: #5a6a7e;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Hierarchy Cards */
        #hierarchy-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-height: 30px;
        }

        .empty-hint {
            text-align: center;
            padding: 24px 16px;
            color: #3a4656;
            font-size: 11px;
        }

        .h-card {
            background: rgba(12, 18, 28, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.06);
            padding: 10px 12px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            animation: fadeSlide 0.2s ease;
        }

        @keyframes fadeSlide {
            from {
                opacity: 0;
                transform: translateY(4px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .h-card.driver {
            border-left: 3px solid #fff;
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.04), rgba(12, 18, 28, 0.9));
        }

        .h-card.passenger {
            border-left: 3px solid #00e5ff;
            background: linear-gradient(90deg, rgba(0, 229, 255, 0.03), rgba(12, 18, 28, 0.9));
        }

        .h-card.backseat {
            border-left: 3px solid #4a5568;
            opacity: 0.7;
        }

        .h-left {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 0;
            flex: 1;
        }

        .h-badge {
            font-size: 8px;
            font-weight: 700;
            text-transform: uppercase;
            padding: 3px 6px;
            border-radius: 3px;
            letter-spacing: 0.5px;
            flex-shrink: 0;
            text-align: center;
            min-width: 48px;
        }

        .b-driver {
            background: #fff;
            color: #000;
        }

        .b-pass {
            background: #00e5ff;
            color: #000;
        }

        .b-back {
            background: rgba(74, 85, 104, 0.4);
            color: #6b7b8f;
        }

        .h-info {
            min-width: 0;
        }

        .h-name {
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .h-title {
            font-size: 9px;
            color: #5a6a7e;
            font-style: italic;
            margin-top: 1px;
        }

        .h-meta {
            font-size: 9px;
            color: #3a4656;
            margin-top: 2px;
        }

        .h-btns {
            display: flex;
            gap: 3px;
            flex-shrink: 0;
            margin-left: 6px;
        }

        .h-btn {
            background: none;
            border: 1px solid rgba(255, 255, 255, 0.06);
            color: #3a4656;
            width: 22px;
            height: 22px;
            border-radius: 3px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
        }

        .h-btn:hover {
            border-color: #5a6a7e;
            color: #dce8f5;
        }

        .h-btn.del:hover {
            border-color: #ff3b5c;
            color: #ff3b5c;
        }

        /* Bio Panel */
        .h-bio {
            display: none;
            padding: 10px 12px;
            margin: -4px 0 4px 0;
            background: rgba(0, 229, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-top: none;
            border-radius: 0 0 6px 6px;
            font-size: 10px;
            line-height: 1.6;
            color: #5a6a7e;
        }

        .h-bio.open {
            display: block;
        }

        .bio-lbl {
            color: #3a4656;
            text-transform: uppercase;
            font-size: 8px;
            letter-spacing: 1px;
            font-weight: 600;
            display: block;
            margin-bottom: 2px;
            margin-top: 6px;
        }

        .bio-lbl:first-child {
            margin-top: 0;
        }

        .bio-val {
            color: #dce8f5;
        }

        .bio-accent {
            color: #00e5ff;
        }

        /* Score Bars */
        .score-section {
            margin-top: 8px;
        }

        .score-row {
            display: flex;
            align-items: center;
            margin-bottom: 3px;
            gap: 4px;
        }

        .score-label {
            font-size: 8px;
            color: #5a6a7e;
            width: 65px;
            flex-shrink: 0;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .score-track {
            flex: 1;
            height: 4px;
            background: rgba(255, 255, 255, 0.04);
            border-radius: 2px;
            overflow: hidden;
            position: relative;
        }

        .score-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .score-val {
            font-size: 8px;
            color: #5a6a7e;
            width: 18px;
            text-align: right;
            flex-shrink: 0;
        }

        .score-divider {
            font-size: 8px;
            color: #2a3444;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 6px 0 4px 0;
            font-weight: 600;
        }

        /* Console */
        #console-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1px;
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 6px;
            overflow: hidden;
            margin-top: 4px;
        }

        .c-cell {
            background: rgba(12, 18, 28, 0.9);
            padding: 10px;
        }

        .c-hdr {
            font-size: 8px;
            color: #3a4656;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 3px;
            font-weight: 600;
        }

        .c-val {
            font-size: 12px;
            font-weight: 600;
        }

        .v-crit {
            color: #ff3b5c;
        }

        .v-warn {
            color: #ffa726;
        }

        .v-good {
            color: #00e676;
        }

        .v-neut {
            color: #dce8f5;
        }

        .v-accent {
            color: #00e5ff;
        }

        /* System Mix Panel */
        #system-mix {
            margin-top: 6px;
            padding: 10px;
            background: rgba(12, 18, 28, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 6px;
        }

        .mix-title {
            font-size: 9px;
            color: #3a4656;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .mix-row {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
            gap: 6px;
        }

        .mix-label {
            font-size: 9px;
            width: 80px;
            flex-shrink: 0;
            font-weight: 500;
        }

        .mix-track {
            flex: 1;
            height: 6px;
            background: rgba(255, 255, 255, 0.04);
            border-radius: 3px;
            overflow: hidden;
            position: relative;
        }

        .mix-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.4s ease;
        }

        .mix-val {
            font-size: 9px;
            width: 24px;
            text-align: right;
            flex-shrink: 0;
            font-weight: 600;
        }

        .mix-category {
            font-size: 8px;
            color: #2a3444;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin: 10px 0 6px 0;
            font-weight: 700;
            padding-bottom: 3px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.04);
        }

        .mix-category:first-child {
            margin-top: 0;
        }

        .mix-highlight {
            background: rgba(0, 229, 255, 0.05);
            border: 1px solid rgba(0, 229, 255, 0.15);
            border-radius: 4px;
            padding: 8px;
            margin-top: 10px;
        }

        .mix-highlight-title {
            font-size: 8px;
            color: #00e5ff;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .mix-highlight-text {
            font-size: 10px;
            color: #dce8f5;
            line-height: 1.4;
        }

        #neural-readout {
            font-size: 10px;
            color: #5a6a7e;
            line-height: 1.6;
            padding: 10px;
            background: rgba(12, 18, 28, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 6px;
            margin-top: 6px;
        }

        .rel-bond {
            color: #00e5ff;
            font-size: 9px;
            margin: 2px 0;
        }

        .rel-rival {
            color: #ef5350;
            font-size: 9px;
            margin: 2px 0;
        }

        .rel-section {
            color: #3a4656;
            font-size: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 6px 0 3px 0;
            font-weight: 600;
        }

        /* Brightness Sliders */
        .brightness-controls {
            position: absolute;
            bottom: 12px;
            left: 12px;
            right: 12px;
            display: flex;
            gap: 16px;
            z-index: 20;
            pointer-events: all;
        }

        .bright-group {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .bright-label {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 8px;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: #5a6a7e;
            white-space: nowrap;
            min-width: 36px;
        }

        .bright-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 3px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 2px;
            outline: none;
            cursor: pointer;
        }

        .bright-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #00e5ff;
            border: 1px solid rgba(0, 229, 255, 0.4);
            cursor: pointer;
        }

        .bright-slider::-moz-range-thumb {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #00e5ff;
            border: 1px solid rgba(0, 229, 255, 0.4);
            cursor: pointer;
        }

        .bright-val {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 9px;
            color: #5a6a7e;
            min-width: 22px;
            text-align: right;
        }

        /* Loading Spinner */
        #stl-loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(3, 5, 8, 0.85);
            z-index: 25;
            pointer-events: none;
            transition: opacity 0.5s;
        }

        #stl-loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .spinner {
            width: 32px;
            height: 32px;
            border: 2px solid rgba(0, 229, 255, 0.15);
            border-top-color: #00e5ff;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .load-text {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 9px;
            color: #5a6a7e;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-top: 10px;
        }

        .load-progress {
            width: 120px;
            height: 2px;
            background: rgba(255, 255, 255, 0.06);
            border-radius: 1px;
            margin-top: 6px;
            overflow: hidden;
        }

        .load-bar {
            height: 100%;
            width: 0%;
            background: #00e5ff;
            border-radius: 1px;
            transition: width 0.3s;
        }

        #error-display {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(255, 50, 50, 0.95);
            color: white;
            padding: 12px;
            border-radius: 6px;
            font-size: 11px;
            z-index: 9999;
        }

        @media(max-width:900px) {
            body {
                flex-direction: column;
            }

            #viewport {
                width: 100%;
                height: 40vh;
                min-height: 220px;
                flex: none;
            }

            #hud {
                width: 100%;
                min-width: 100%;
                height: 60vh;
                flex: none;
                border-left: none;
                border-top: 1px solid rgba(255, 255, 255, 0.06);
            }
        }
    </style>
</head>

<body>
    <div id="viewport">
        <div class="vp-label" id="vp-tl">Axial · Sagittal Composite</div>
        <div class="vp-label" id="vp-bl">Idle</div>
        <div id="stl-loading-overlay">
            <div class="spinner"></div>
            <div class="load-text">Loading brain model…</div>
            <div class="load-progress">
                <div class="load-bar" id="load-bar"></div>
            </div>
        </div>
        <div id="stl-drop-overlay">Drop STL Brain Model Here</div>
        <input type="file" id="stl-file-input" accept=".stl">
        <button id="shell-toggle" class="vp-btn state-dim">Shell: Loading…</button>
        <button id="reset-view" class="vp-btn">Recenter</button>
        <div class="brightness-controls">
            <div class="bright-group">
                <span class="bright-label">Shell</span>
                <input type="range" id="shell-brightness" class="bright-slider" min="0" max="100" value="50">
                <span class="bright-val" id="shell-bright-val">50</span>
            </div>
            <div class="bright-group">
                <span class="bright-label">Cloud</span>
                <input type="range" id="cloud-brightness" class="bright-slider" min="0" max="100" value="85">
                <span class="bright-val" id="cloud-bright-val">85</span>
            </div>
        </div>

    </div>
    <div id="hud">
        <div id="hud-header">
            <h1>System Atlas</h1><span id="active-count">0 Active</span>
        </div>
        <div class="scroll-zone">
            <div class="section-label">Inject Alter</div>
            <input type="text" id="search-input" placeholder="Search by name or title…" autocomplete="off"
                spellcheck="false">
            <div id="alter-dropdown"></div>
            <div class="section-label">Hierarchy</div>
            <div id="hierarchy-list">
                <div class="empty-hint"><span
                        style="display:block;font-size:28px;margin-bottom:10px;opacity:0.3">&#9671;</span>Search and
                    inject an alter<br><small style="color:#2a3444">Drag to rotate · Scroll to zoom</small></div>
            </div>
            <div class="section-label">Driver State</div>
            <div id="console-grid">
                <div class="c-cell">
                    <div class="c-hdr">Primary Mode</div>
                    <div class="c-val v-neut" id="v-mode">—</div>
                </div>
                <div class="c-cell">
                    <div class="c-hdr">Dominant Strength</div>
                    <div class="c-val v-neut" id="v-strength">—</div>
                </div>
                <div class="c-cell">
                    <div class="c-hdr">Risk Factor</div>
                    <div class="c-val v-neut" id="v-risk">—</div>
                </div>
                <div class="c-cell">
                    <div class="c-hdr">Coherence</div>
                    <div class="c-val v-neut" id="v-coh">—</div>
                </div>
            </div>
            <div class="section-label">System Mix Analysis</div>
            <div id="system-mix"><span style="color:#3a4656;font-size:10px">Inject alters to see combined trait
                    analysis</span></div>
            <div class="section-label">Neural Map</div>
            <div id="neural-readout"><span style="color:#3a4656">Awaiting alter injection…</span></div>
        </div>
    </div>
    <div id="error-display"></div>

    <script>window.onerror = function (m, u, l) { var e = document.getElementById('error-display'); if (e) { e.style.display = 'block'; e.innerHTML += '<div>' + m + ' (L' + l + ')</div>'; } };</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/loaders/STLLoader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <script>
        (function () {
            "use strict";
            if (typeof THREE === 'undefined') { document.getElementById('error-display').style.display = 'block'; document.getElementById('error-display').innerHTML = 'Three.js failed to load.'; return; }

            /* ═══ STL URL — update after uploading to GitHub Releases ═══ */
            var STL_URL = 'https://github.com/user-attachments/files/25353830/brain_final.stl.gz';

            /* ═══════════════════════════════════════════
               ROI COORDINATES
               ═══════════════════════════════════════════ */
            var ROI = {
                DLPFC_L: { x: 3.0, y: 3.5, z: 4.0, label: "Left DLPFC" }, DLPFC_R: { x: -3.0, y: 3.5, z: 4.0, label: "Right DLPFC" }, VMPFC: { x: 0, y: -0.5, z: 5.0, label: "Ventromedial PFC" }, OFC: { x: 0, y: -2.0, z: 4.5, label: "Orbitofrontal Cortex" }, Rostral_PFC: { x: 0, y: 4.5, z: 5.0, label: "Rostral PFC" }, mPFC: { x: 0, y: 1.5, z: 5.5, label: "Medial PFC" }, Broca: { x: 4.5, y: 1.0, z: 3.0, label: "Broca's Area" }, SMA: { x: 0, y: 5.0, z: 0.5, label: "Supp. Motor" }, Motor_L: { x: 2.0, y: 5.5, z: -0.5, label: "L Motor Cortex" }, Motor_R: { x: -2.0, y: 5.5, z: -0.5, label: "R Motor Cortex" }, Parietal_R: { x: -4.0, y: 3.5, z: -3.0, label: "R Parietal" }, TPJ_R: { x: -4.5, y: 1.0, z: -2.5, label: "R TPJ" }, Somato: { x: 1.5, y: 4.5, z: -1.0, label: "Somatosensory" }, SPL: { x: 0, y: 5.0, z: -3.0, label: "Sup. Parietal" }, Temp_Pole_L: { x: 3.5, y: -2.5, z: 2.5, label: "L Temporal Pole" }, Wernicke: { x: 5.0, y: -1.0, z: -2.0, label: "Wernicke's" }, STG: { x: 4.5, y: -0.5, z: -1.5, label: "Sup. Temporal G." }, Amygdala_L: { x: 1.8, y: -2.5, z: 1.0, label: "L Amygdala" }, Amygdala_R: { x: -1.8, y: -2.5, z: 1.0, label: "R Amygdala" }, Hippo_L: { x: 2.0, y: -3.0, z: -0.5, label: "L Hippocampus" }, Hippo_R: { x: -2.0, y: -3.0, z: -0.5, label: "R Hippocampus" }, Insula_L: { x: 3.2, y: -0.5, z: 1.5, label: "L Insula" }, Insula_R: { x: -3.2, y: -0.5, z: 1.5, label: "R Insula" }, Ant_Insula: { x: 3.5, y: 0.5, z: 2.0, label: "Ant. Insula" }, ACC: { x: 0, y: 1.0, z: 2.5, label: "Ant. Cingulate" }, sgACC: { x: 0, y: -1.0, z: 3.5, label: "Subgenual ACC" }, dACC: { x: 0, y: 2.0, z: 3.0, label: "Dorsal ACC" }, PCC: { x: 0, y: 1.0, z: -3.0, label: "Post. Cingulate" }, Striatum: { x: 1.5, y: -0.5, z: 1.5, label: "Striatum" }, NucAcc: { x: 0.8, y: -1.5, z: 2.0, label: "Nuc. Accumbens" }, Caudate: { x: 1.0, y: 0.5, z: 2.0, label: "Caudate" }, VTA: { x: 0, y: -2.5, z: 0.5, label: "VTA" }, Thalamus: { x: 0, y: -1.0, z: 0.5, label: "Thalamus" }, V1: { x: 0, y: -1.0, z: -5.5, label: "Primary Visual" }, V4: { x: -2.0, y: -2.0, z: -5.5, label: "V4" }, EBA: { x: -4.0, y: -1.0, z: -4.5, label: "Extrastriate Body" }, Brainstem: { x: 0, y: -5.0, z: -0.5, label: "Brainstem" }, PAG: { x: 0, y: -4.0, z: 0, label: "PAG" }, VLPO: { x: 0, y: -3.5, z: 1.0, label: "VLPO" }, Locus_C: { x: 0, y: -4.5, z: -1.5, label: "Locus Coeruleus" }, Cerebellum: { x: 0, y: -5.0, z: -3.5, label: "Cerebellum" }, Vagus: { x: 0.5, y: -6.0, z: -0.5, label: "Vagal Complex" }, Raphe: { x: 0, y: -4.5, z: -0.5, label: "Raphe Nuclei" }, Olfactory: { x: 0, y: -2.0, z: 4.0, label: "Olfactory" }, DMN: { x: 0, y: 2.0, z: -2.0, label: "Default Mode" }, Precuneus: { x: 0, y: 3.0, z: -3.5, label: "Precuneus" }
            };

            /* ═══════════════════════════════════════════
               SCORING SYSTEM
               Strengths: exec, social, creative, resilience, empathy, humor, physical, intellect
               Clinical:  dissoc, anxiety, narcissism, impulsivity, rigidity, avoidance, shame, hypervig
               ═══════════════════════════════════════════ */

            // Strength labels/colors and Clinical labels/colors
            var STR_KEYS = ['exec', 'social', 'creative', 'resilience', 'empathy', 'humor', 'physical', 'intellect'];
            var STR_LABELS = ['Executive', 'Social', 'Creative', 'Resilience', 'Empathy', 'Humor', 'Physical', 'Intellect'];
            var STR_COLORS = ['#00e5ff', '#4dd0e1', '#80deea', '#00e676', '#66bb6a', '#ffd54f', '#ff8a65', '#ce93d8'];

            var CLN_KEYS = ['dissoc', 'anxiety', 'narcissism', 'impulsivity', 'rigidity', 'avoidance', 'shame', 'hypervig'];
            var CLN_LABELS = ['Dissociation', 'Anxiety', 'Narcissism', 'Impulsivity', 'Rigidity', 'Avoidance', 'Shame', 'Hypervigilance'];
            var CLN_COLORS = ['#9575cd', '#ef5350', '#ffa726', '#ff7043', '#78909c', '#546e7a', '#8d6e63', '#e57373'];

            /* ═══════════════════════════════════════════
               66 ALTER DATABASE with full scoring
               ═══════════════════════════════════════════ */
            var DB = {
                "Ethan": {
                    c: "#88CCFF", loc: ROI.DLPFC_L, title: "The Interface", weight: "CRITICAL", fn: "ANP — handles daily life, social survival. Customer-service voice, people-pleasing.", region: "Left DLPFC",
                    str: { exec: 7, social: 8, creative: 3, resilience: 6, empathy: 5, humor: 4, physical: 3, intellect: 5 },
                    cln: { dissoc: 4, anxiety: 5, narcissism: 1, impulsivity: 2, rigidity: 4, avoidance: 6, shame: 3, hypervig: 3 }
                },
                "Synthia": {
                    c: "#E8F0FF", loc: ROI.OFC, title: "The Curator of Perfection", weight: "HIGH", fn: "Fawn Response Weaponized. Perfection as safety. Environmental control.", region: "OFC",
                    str: { exec: 9, social: 4, creative: 3, resilience: 5, empathy: 2, humor: 1, physical: 2, intellect: 6 },
                    cln: { dissoc: 3, anxiety: 7, narcissism: 3, impulsivity: 1, rigidity: 10, avoidance: 4, shame: 5, hypervig: 6 }
                },
                "Alexander": {
                    c: "#FFA500", loc: ROI.NucAcc, title: "The Master Hunter", weight: "HIGH", fn: "Ego Prosthetic. Counters shame via validation-seeking.", region: "Nuc. Accumbens",
                    str: { exec: 5, social: 10, creative: 4, resilience: 7, empathy: 2, humor: 6, physical: 8, intellect: 3 },
                    cln: { dissoc: 2, anxiety: 3, narcissism: 9, impulsivity: 8, rigidity: 2, avoidance: 1, shame: 1, hypervig: 4 }
                },
                "The Watcher": {
                    c: "#556677", loc: ROI.PCC, title: "The Black Box", weight: "FOUNDATIONAL", fn: "Pure awareness untouched by trauma. 'I am.'", region: "PCC/Precuneus",
                    str: { exec: 1, social: 0, creative: 2, resilience: 10, empathy: 3, humor: 0, physical: 0, intellect: 7 },
                    cln: { dissoc: 10, anxiety: 0, narcissism: 0, impulsivity: 0, rigidity: 0, avoidance: 8, shame: 0, hypervig: 0 }
                },
                "Sleeper": {
                    c: "#3344AA", loc: ROI.VLPO, title: "The Force of Nature", weight: "CRITICAL", fn: "Circuit-breaker. Forced shutdown on emotional overload.", region: "VLPO",
                    str: { exec: 2, social: 0, creative: 0, resilience: 10, empathy: 0, humor: 0, physical: 1, intellect: 1 },
                    cln: { dissoc: 10, anxiety: 0, narcissism: 0, impulsivity: 0, rigidity: 8, avoidance: 10, shame: 0, hypervig: 0 }
                },
                "Rylee": {
                    c: "#FF4500", loc: ROI.Motor_L, title: "The Kinetic Rebel", weight: "MEDIUM-HIGH", fn: "Breaks the Freeze. Impulse Override. 'Watch me.'", region: "Motor Cortex",
                    str: { exec: 3, social: 7, creative: 5, resilience: 9, empathy: 3, humor: 6, physical: 10, intellect: 2 },
                    cln: { dissoc: 2, anxiety: 2, narcissism: 4, impulsivity: 10, rigidity: 1, avoidance: 1, shame: 1, hypervig: 3 }
                },
                "Payne": {
                    c: "#445566", loc: ROI.sgACC, title: "The Bedrock", weight: "MASSIVE", fn: "Container of Toxic Shame. The 'Bad Object.' Quarantine for self-hatred.", region: "Subgenual ACC",
                    str: { exec: 1, social: 0, creative: 2, resilience: 8, empathy: 7, humor: 0, physical: 1, intellect: 3 },
                    cln: { dissoc: 8, anxiety: 7, narcissism: 0, impulsivity: 1, rigidity: 3, avoidance: 9, shame: 10, hypervig: 4 }
                },
                "The Beginning": {
                    c: "#FFFF00", loc: ROI.VTA, title: "The Unscathed Spirit", weight: "PROTECTED CORE", fn: "Hope Reservoir. Original factory settings. Pure joy.", region: "VTA",
                    str: { exec: 2, social: 8, creative: 9, resilience: 7, empathy: 9, humor: 8, physical: 6, intellect: 4 },
                    cln: { dissoc: 5, anxiety: 2, narcissism: 0, impulsivity: 9, rigidity: 0, avoidance: 0, shame: 0, hypervig: 1 }
                },
                "Elder Repression": {
                    c: "#2a2a6e", loc: ROI.dACC, title: "The Inquisitor", weight: "HIGH", fn: "Internalized religious authority. Obedience as survival.", region: "Dorsal ACC",
                    str: { exec: 6, social: 3, creative: 1, resilience: 7, empathy: 1, humor: 0, physical: 2, intellect: 5 },
                    cln: { dissoc: 3, anxiety: 6, narcissism: 2, impulsivity: 1, rigidity: 10, avoidance: 5, shame: 8, hypervig: 7 }
                },
                "Janet": {
                    c: "#4682B4", loc: ROI.DLPFC_L, title: "The Advisor", weight: "HIGH", fn: "Administrator. Feelings are data. Keeps the rent paid.", region: "Left DLPFC",
                    str: { exec: 9, social: 5, creative: 2, resilience: 7, empathy: 4, humor: 2, physical: 2, intellect: 8 },
                    cln: { dissoc: 3, anxiety: 4, narcissism: 1, impulsivity: 1, rigidity: 7, avoidance: 4, shame: 2, hypervig: 3 }
                },
                "Danny": {
                    c: "#FF1493", loc: ROI.NucAcc, title: "The Vibe Shift", weight: "HIGH", fn: "Flight as Party. Outrun the void with euphoria.", region: "Nuc. Accumbens",
                    str: { exec: 3, social: 10, creative: 7, resilience: 5, empathy: 4, humor: 9, physical: 7, intellect: 2 },
                    cln: { dissoc: 4, anxiety: 2, narcissism: 6, impulsivity: 9, rigidity: 1, avoidance: 3, shame: 1, hypervig: 2 }
                },
                "The Mediator": {
                    c: "#FFFFFF", loc: ROI.mPFC, title: "The Cosmic Switchboard", weight: "CRITICAL", fn: "Internal Self-Helper. Bridge between fragments.", region: "Medial PFC",
                    str: { exec: 8, social: 6, creative: 4, resilience: 7, empathy: 8, humor: 3, physical: 1, intellect: 9 },
                    cln: { dissoc: 6, anxiety: 3, narcissism: 0, impulsivity: 1, rigidity: 3, avoidance: 2, shame: 1, hypervig: 2 }
                },
                "Kyle": {
                    c: "#FF69B4", loc: ROI.Ant_Insula, title: "The Vulnerable Heart", weight: "HIGH", fn: "Attachment Keeper. 'Skin is truth.' Keeps the door open.", region: "Ant. Insula",
                    str: { exec: 2, social: 7, creative: 5, resilience: 4, empathy: 10, humor: 2, physical: 5, intellect: 3 },
                    cln: { dissoc: 4, anxiety: 7, narcissism: 2, impulsivity: 6, rigidity: 1, avoidance: 1, shame: 5, hypervig: 3 }
                },
                "Jabez": {
                    c: "#334444", loc: ROI.Raphe, title: "The Void", weight: "VARIABLE", fn: "Emergency Exit. Nihilistic safety net.", region: "Raphe Nuclei",
                    str: { exec: 1, social: 0, creative: 3, resilience: 6, empathy: 2, humor: 0, physical: 0, intellect: 5 },
                    cln: { dissoc: 9, anxiety: 3, narcissism: 0, impulsivity: 4, rigidity: 1, avoidance: 10, shame: 8, hypervig: 1 }
                },
                "Nikolai": {
                    c: "#8B4513", loc: ROI.Motor_R, title: "The Laborer", weight: "HIGH", fn: "Machine-mode. Somatic Dissociation through labor.", region: "Motor Cortex",
                    str: { exec: 7, social: 1, creative: 1, resilience: 10, empathy: 1, humor: 0, physical: 10, intellect: 3 },
                    cln: { dissoc: 6, anxiety: 3, narcissism: 0, impulsivity: 2, rigidity: 7, avoidance: 6, shame: 4, hypervig: 3 }
                },
                "Vendilla": {
                    c: "#B0C4DE", loc: ROI.TPJ_R, title: "The Ancient Observer", weight: "MEDIUM", fn: "Intellectual Dissociation. Cosmic perspective.", region: "R TPJ",
                    str: { exec: 3, social: 5, creative: 7, resilience: 8, empathy: 5, humor: 4, physical: 1, intellect: 9 },
                    cln: { dissoc: 9, anxiety: 1, narcissism: 2, impulsivity: 1, rigidity: 2, avoidance: 5, shame: 0, hypervig: 1 }
                },
                "Luke": {
                    c: "#228B22", loc: ROI.Vagus, title: "The Cabin Keeper", weight: "MEDIUM", fn: "Anti-Performance. Recovery specialist.", region: "Vagal Complex",
                    str: { exec: 2, social: 1, creative: 4, resilience: 7, empathy: 5, humor: 2, physical: 3, intellect: 4 },
                    cln: { dissoc: 5, anxiety: 2, narcissism: 0, impulsivity: 1, rigidity: 2, avoidance: 7, shame: 2, hypervig: 1 }
                },
                "Tom": {
                    c: "#DAA520", loc: ROI.VMPFC, title: "The Good Father", weight: "MEDIUM", fn: "Internalized Secure Attachment. Healthy masculinity.", region: "VMPFC",
                    str: { exec: 6, social: 7, creative: 3, resilience: 7, empathy: 8, humor: 4, physical: 6, intellect: 5 },
                    cln: { dissoc: 2, anxiety: 3, narcissism: 1, impulsivity: 3, rigidity: 3, avoidance: 2, shame: 2, hypervig: 2 }
                },
                "Thomas": {
                    c: "#556B2F", loc: ROI.SMA, title: "The Mindful Wanderer", weight: "MEDIUM", fn: "Natural EMDR via walking. Movement as medicine.", region: "SMA",
                    str: { exec: 3, social: 2, creative: 5, resilience: 7, empathy: 5, humor: 2, physical: 7, intellect: 5 },
                    cln: { dissoc: 6, anxiety: 3, narcissism: 0, impulsivity: 3, rigidity: 2, avoidance: 4, shame: 2, hypervig: 2 }
                },
                "Tanti": {
                    c: "#00CED1", loc: ROI.Caudate, title: "The Digital Gladiator", weight: "MEDIUM", fn: "Fight sublimated into pixels. 'Life is a skill issue.'", region: "Caudate",
                    str: { exec: 6, social: 4, creative: 3, resilience: 7, empathy: 1, humor: 4, physical: 4, intellect: 7 },
                    cln: { dissoc: 7, anxiety: 2, narcissism: 3, impulsivity: 8, rigidity: 4, avoidance: 5, shame: 1, hypervig: 3 }
                },
                "Spencer": {
                    c: "#87CEEB", loc: ROI.Broca, title: "The Social Alchemist", weight: "MEDIUM", fn: "Identity Diffusion defense. 'Spencer from NZ.'", region: "Broca's Area",
                    str: { exec: 5, social: 9, creative: 7, resilience: 5, empathy: 5, humor: 7, physical: 4, intellect: 6 },
                    cln: { dissoc: 5, anxiety: 4, narcissism: 4, impulsivity: 7, rigidity: 2, avoidance: 2, shame: 2, hypervig: 3 }
                },
                "Sequoia": {
                    c: "#3CB371", loc: ROI.Insula_L, title: "High Priestess of Chill", weight: "MEDIUM", fn: "Chemical Containment. Designated substance-use alter.", region: "L Insula",
                    str: { exec: 1, social: 6, creative: 5, resilience: 4, empathy: 4, humor: 5, physical: 3, intellect: 3 },
                    cln: { dissoc: 8, anxiety: 1, narcissism: 1, impulsivity: 7, rigidity: 0, avoidance: 6, shame: 2, hypervig: 0 }
                },
                "Zen Master Roshi": {
                    c: "#FFA07A", loc: ROI.Rostral_PFC, title: "The Trickster Sage", weight: "LOW", fn: "Humor as Defense. Deflates guilt with comedy.", region: "Rostral PFC",
                    str: { exec: 3, social: 7, creative: 6, resilience: 5, empathy: 4, humor: 10, physical: 2, intellect: 6 },
                    cln: { dissoc: 4, anxiety: 2, narcissism: 3, impulsivity: 6, rigidity: 1, avoidance: 3, shame: 1, hypervig: 1 }
                },
                "Future": {
                    c: "#FFD700", loc: ROI.Rostral_PFC, title: "The North Star", weight: "HIGH", fn: "Future Self-Continuity. Sets the GPS while others drive.", region: "Rostral PFC",
                    str: { exec: 7, social: 5, creative: 6, resilience: 8, empathy: 5, humor: 3, physical: 2, intellect: 7 },
                    cln: { dissoc: 3, anxiety: 3, narcissism: 2, impulsivity: 2, rigidity: 3, avoidance: 2, shame: 1, hypervig: 2 }
                },
                "Ms. Higgins": {
                    c: "#D8BFD8", loc: ROI.Insula_R, title: "The Hearth Keeper", weight: "MEDIUM", fn: "Internal Attachment Figure. Validates vulnerability.", region: "R Insula",
                    str: { exec: 4, social: 7, creative: 3, resilience: 6, empathy: 10, humor: 3, physical: 2, intellect: 4 },
                    cln: { dissoc: 2, anxiety: 3, narcissism: 0, impulsivity: 1, rigidity: 3, avoidance: 2, shame: 1, hypervig: 1 }
                },
                "Keon": {
                    c: "#32CD32", loc: ROI.Parietal_R, title: "The Curator of Wonder", weight: "MEDIUM", fn: "Preservation of Wonder. ND traits — the infodump engine.", region: "R Parietal",
                    str: { exec: 4, social: 3, creative: 8, resilience: 6, empathy: 5, humor: 5, physical: 3, intellect: 9 },
                    cln: { dissoc: 5, anxiety: 4, narcissism: 1, impulsivity: 6, rigidity: 3, avoidance: 3, shame: 2, hypervig: 2 }
                },
                "Kane": {
                    c: "#228B22", loc: ROI.Locus_C, title: "The Sentry", weight: "MEDIUM", fn: "Reality Tester. Hard reality check against magical thinking.", region: "Locus Coeruleus",
                    str: { exec: 6, social: 1, creative: 2, resilience: 8, empathy: 2, humor: 1, physical: 7, intellect: 6 },
                    cln: { dissoc: 2, anxiety: 4, narcissism: 0, impulsivity: 2, rigidity: 5, avoidance: 3, shame: 1, hypervig: 8 }
                },
                "Juan Carlos": {
                    c: "#FF4500", loc: ROI.Broca, title: "The Fearless Speaker", weight: "MEDIUM", fn: "Anti-Shame. Imperfection is lovable. 'No pasa nada.'", region: "Broca's Area",
                    str: { exec: 4, social: 9, creative: 6, resilience: 7, empathy: 5, humor: 8, physical: 4, intellect: 5 },
                    cln: { dissoc: 3, anxiety: 2, narcissism: 3, impulsivity: 8, rigidity: 1, avoidance: 1, shame: 1, hypervig: 1 }
                },
                "Joshua": {
                    c: "#DEB887", loc: ROI.Striatum, title: "The Service Top", weight: "MEDIUM-HIGH", fn: "Sublimation of Dominance through service.", region: "Striatum",
                    str: { exec: 7, social: 7, creative: 3, resilience: 7, empathy: 5, humor: 3, physical: 8, intellect: 4 },
                    cln: { dissoc: 2, anxiety: 3, narcissism: 4, impulsivity: 4, rigidity: 4, avoidance: 1, shame: 2, hypervig: 3 }
                },
                "John": {
                    c: "#708090", loc: ROI.PAG, title: "The Cold Tactician", weight: "HIGH IMPACT", fn: "Persecutor-Protector. Nuclear option.", region: "PAG",
                    str: { exec: 6, social: 1, creative: 1, resilience: 10, empathy: 1, humor: 0, physical: 7, intellect: 6 },
                    cln: { dissoc: 7, anxiety: 2, narcissism: 2, impulsivity: 1, rigidity: 6, avoidance: 6, shame: 3, hypervig: 10 }
                },
                "Joey": {
                    c: "#B22222", loc: ROI.Amygdala_R, title: "The Bouncer", weight: "MEDIUM", fn: "Intimidation Shield. Only one who says 'No.'", region: "R Amygdala",
                    str: { exec: 4, social: 4, creative: 2, resilience: 8, empathy: 2, humor: 3, physical: 7, intellect: 3 },
                    cln: { dissoc: 3, anxiety: 4, narcissism: 3, impulsivity: 8, rigidity: 3, avoidance: 2, shame: 2, hypervig: 8 }
                },
                "Jens": {
                    c: "#E6E6FA", loc: ROI.Temp_Pole_L, title: "The Passive Poet", weight: "LOW", fn: "Reframes desire as 'being wanted.' The loophole.", region: "L Temporal Pole",
                    str: { exec: 2, social: 3, creative: 6, resilience: 3, empathy: 6, humor: 2, physical: 3, intellect: 4 },
                    cln: { dissoc: 6, anxiety: 5, narcissism: 1, impulsivity: 2, rigidity: 2, avoidance: 5, shame: 6, hypervig: 2 }
                },
                "Jane Parker": {
                    c: "#FFB6C1", loc: ROI.Insula_R, title: "The Southern Mom", weight: "MEDIUM", fn: "Internal Reparenting. 'Food is love.'", region: "R Insula",
                    str: { exec: 5, social: 8, creative: 6, resilience: 6, empathy: 9, humor: 5, physical: 4, intellect: 4 },
                    cln: { dissoc: 2, anxiety: 3, narcissism: 1, impulsivity: 2, rigidity: 4, avoidance: 2, shame: 1, hypervig: 2 }
                },
                "Jameson": {
                    c: "#880000", loc: ROI.Cerebellum, title: "The Kinetic Valve", weight: "LOW", fn: "Turns rage into chopping wood. Kinetic discharge.", region: "Cerebellum",
                    str: { exec: 3, social: 2, creative: 2, resilience: 9, empathy: 1, humor: 1, physical: 10, intellect: 1 },
                    cln: { dissoc: 3, anxiety: 2, narcissism: 1, impulsivity: 9, rigidity: 2, avoidance: 2, shame: 2, hypervig: 4 }
                },
                "Ivan": {
                    c: "#8B4513", loc: ROI.Hippo_L, title: "The Archive", weight: "HIGH", fn: "Intellectualization. Turns trauma into psychology.", region: "L Hippocampus",
                    str: { exec: 7, social: 3, creative: 4, resilience: 6, empathy: 3, humor: 2, physical: 1, intellect: 10 },
                    cln: { dissoc: 5, anxiety: 4, narcissism: 2, impulsivity: 1, rigidity: 5, avoidance: 5, shame: 2, hypervig: 3 }
                },
                "Isabella": {
                    c: "#DC143C", loc: ROI.V4, title: "The Aesthetic Eye", weight: "HIGH", fn: "Aesthetic Shield. Look perfect, avoid pity.", region: "V4",
                    str: { exec: 6, social: 7, creative: 10, resilience: 5, empathy: 3, humor: 3, physical: 4, intellect: 5 },
                    cln: { dissoc: 3, anxiety: 4, narcissism: 6, impulsivity: 5, rigidity: 6, avoidance: 2, shame: 3, hypervig: 4 }
                },
                "Hypnosis": {
                    c: "#4169E1", loc: ROI.Thalamus, title: "The Somatic Healer", weight: "HIGH", fn: "Internal Secure Base. Deep trance healing.", region: "Thalamus",
                    str: { exec: 2, social: 1, creative: 4, resilience: 8, empathy: 7, humor: 0, physical: 3, intellect: 4 },
                    cln: { dissoc: 9, anxiety: 1, narcissism: 0, impulsivity: 0, rigidity: 2, avoidance: 5, shame: 0, hypervig: 0 }
                },
                "Hank": {
                    c: "#708090", loc: ROI.DLPFC_R, title: "The Skeptic", weight: "MEDIUM-HIGH", fn: "Denial Defense. 'Feelings are a luxury.'", region: "R DLPFC",
                    str: { exec: 6, social: 3, creative: 1, resilience: 8, empathy: 1, humor: 3, physical: 5, intellect: 5 },
                    cln: { dissoc: 3, anxiety: 2, narcissism: 2, impulsivity: 2, rigidity: 7, avoidance: 7, shame: 3, hypervig: 4 }
                },
                "Hans": {
                    c: "#C0C0C0", loc: ROI.EBA, title: "The Diva", weight: "MEDIUM", fn: "Narcissistic Shield. 'I am my body.' Body dysmorphia.", region: "Extrastriate Body",
                    str: { exec: 4, social: 5, creative: 6, resilience: 4, empathy: 2, humor: 3, physical: 8, intellect: 3 },
                    cln: { dissoc: 4, anxiety: 5, narcissism: 8, impulsivity: 5, rigidity: 5, avoidance: 2, shame: 5, hypervig: 5 }
                },
                "Dr. Gretchen": {
                    c: "#DDDDDD", loc: ROI.DLPFC_L, title: "The Scientist", weight: "MEDIUM", fn: "Rationalization. Explains emotion away.", region: "L DLPFC",
                    str: { exec: 8, social: 3, creative: 2, resilience: 6, empathy: 2, humor: 1, physical: 1, intellect: 9 },
                    cln: { dissoc: 3, anxiety: 3, narcissism: 3, impulsivity: 1, rigidity: 7, avoidance: 5, shame: 1, hypervig: 2 }
                },
                "Frank": {
                    c: "#A52A2A", loc: ROI.Amygdala_L, title: "The Shock Jock", weight: "LOW", fn: "Counter-Phobic. Holds the Shadow.", region: "L Amygdala",
                    str: { exec: 2, social: 5, creative: 5, resilience: 7, empathy: 1, humor: 7, physical: 4, intellect: 3 },
                    cln: { dissoc: 2, anxiety: 2, narcissism: 5, impulsivity: 9, rigidity: 1, avoidance: 1, shame: 2, hypervig: 3 }
                },
                "Francois": {
                    c: "#FFF5E6", loc: ROI.Olfactory, title: "The Alchemist", weight: "MEDIUM", fn: "Survival Creativity through food. 'Food is life.'", region: "Olfactory",
                    str: { exec: 5, social: 7, creative: 9, resilience: 5, empathy: 7, humor: 4, physical: 3, intellect: 4 },
                    cln: { dissoc: 2, anxiety: 2, narcissism: 2, impulsivity: 4, rigidity: 3, avoidance: 1, shame: 1, hypervig: 1 }
                },
                "Explorer": {
                    c: "#00DDDD", loc: ROI.TPJ_R, title: "The Quantum Hitchhiker", weight: "LOW", fn: "Depersonalization. It's just a simulation.", region: "R TPJ",
                    str: { exec: 3, social: 2, creative: 6, resilience: 7, empathy: 2, humor: 3, physical: 2, intellect: 8 },
                    cln: { dissoc: 9, anxiety: 2, narcissism: 1, impulsivity: 2, rigidity: 2, avoidance: 6, shame: 1, hypervig: 2 }
                },
                "Enrique": {
                    c: "#8B008B", loc: ROI.Somato, title: "The Sensualist", weight: "LOW", fn: "Restoration of Dignity in intimacy.", region: "Somatosensory",
                    str: { exec: 2, social: 7, creative: 7, resilience: 4, empathy: 8, humor: 3, physical: 6, intellect: 3 },
                    cln: { dissoc: 3, anxiety: 3, narcissism: 3, impulsivity: 4, rigidity: 1, avoidance: 1, shame: 3, hypervig: 1 }
                },
                "Entertainer": {
                    c: "#FFFF00", loc: ROI.mPFC, title: "The Social Bomb Squad", weight: "HIGH", fn: "Anxiety transmuted to comedy. De-escalation.", region: "Medial PFC",
                    str: { exec: 4, social: 10, creative: 8, resilience: 5, empathy: 5, humor: 10, physical: 5, intellect: 5 },
                    cln: { dissoc: 4, anxiety: 5, narcissism: 4, impulsivity: 7, rigidity: 1, avoidance: 2, shame: 2, hypervig: 3 }
                },
                "Ean": {
                    c: "#3a5555", loc: ROI.VTA, title: "The Shadow Boy", weight: "MEDIUM", fn: "Scapegoat for Sexuality. The 'Not Me.'", region: "VTA",
                    str: { exec: 1, social: 0, creative: 2, resilience: 4, empathy: 2, humor: 0, physical: 2, intellect: 2 },
                    cln: { dissoc: 8, anxiety: 6, narcissism: 1, impulsivity: 8, rigidity: 2, avoidance: 5, shame: 9, hypervig: 3 }
                },
                "Duane": {
                    c: "#DA70D6", loc: ROI.STG, title: "The Camp Spirit", weight: "LOW", fn: "Camp Defense. Life as performance.", region: "Sup. Temporal G.",
                    str: { exec: 3, social: 8, creative: 8, resilience: 4, empathy: 4, humor: 9, physical: 3, intellect: 4 },
                    cln: { dissoc: 3, anxiety: 3, narcissism: 4, impulsivity: 5, rigidity: 1, avoidance: 2, shame: 2, hypervig: 1 }
                },
                "Duke Rutherford": {
                    c: "#8899AA", loc: ROI.Hippo_R, title: "The Strategist", weight: "MEDIUM", fn: "Pattern recognition as defense. History repeats.", region: "R Hippocampus",
                    str: { exec: 7, social: 3, creative: 3, resilience: 6, empathy: 2, humor: 2, physical: 1, intellect: 8 },
                    cln: { dissoc: 4, anxiety: 4, narcissism: 3, impulsivity: 1, rigidity: 6, avoidance: 4, shame: 1, hypervig: 6 }
                },
                "Collin": {
                    c: "#4682B4", loc: ROI.ACC, title: "The Editor of Regret", weight: "HIGH", fn: "Anxiety as defense. 'If it was my fault, I can prevent it.'", region: "ACC",
                    str: { exec: 5, social: 2, creative: 3, resilience: 5, empathy: 5, humor: 1, physical: 2, intellect: 6 },
                    cln: { dissoc: 5, anxiety: 10, narcissism: 1, impulsivity: 3, rigidity: 6, avoidance: 4, shame: 7, hypervig: 5 }
                },
                "Chogi Doshin": {
                    c: "#FFDAB9", loc: ROI.Precuneus, title: "The Bodhisattva", weight: "HIGH", fn: "Radical acceptance. 'This is the river.'", region: "Precuneus",
                    str: { exec: 3, social: 4, creative: 5, resilience: 9, empathy: 10, humor: 3, physical: 2, intellect: 8 },
                    cln: { dissoc: 6, anxiety: 1, narcissism: 0, impulsivity: 0, rigidity: 1, avoidance: 3, shame: 0, hypervig: 0 }
                },
                "Cho": {
                    c: "#F5DEB3", loc: ROI.Wernicke, title: "The Humble Novice", weight: "LOW", fn: "Container of Intellectual Shame.", region: "Wernicke's",
                    str: { exec: 3, social: 2, creative: 3, resilience: 4, empathy: 5, humor: 1, physical: 1, intellect: 6 },
                    cln: { dissoc: 4, anxiety: 5, narcissism: 0, impulsivity: 1, rigidity: 3, avoidance: 4, shame: 7, hypervig: 2 }
                },
                "Charlie": {
                    c: "#CD853F", loc: ROI.SPL, title: "The Artful Dodger", weight: "LOW", fn: "Circumvention. 'If you can sneak out, you aren't a prisoner.'", region: "Sup. Parietal",
                    str: { exec: 5, social: 5, creative: 7, resilience: 6, empathy: 2, humor: 6, physical: 6, intellect: 6 },
                    cln: { dissoc: 4, anxiety: 3, narcissism: 3, impulsivity: 9, rigidity: 1, avoidance: 2, shame: 1, hypervig: 5 }
                },
                "Charles": {
                    c: "#483D8B", loc: ROI.Rostral_PFC, title: "The Snob", weight: "MEDIUM", fn: "Grandiose Defense. 'I am exclusive.'", region: "Rostral PFC",
                    str: { exec: 5, social: 4, creative: 4, resilience: 5, empathy: 1, humor: 2, physical: 2, intellect: 7 },
                    cln: { dissoc: 3, anxiety: 3, narcissism: 8, impulsivity: 2, rigidity: 6, avoidance: 5, shame: 4, hypervig: 3 }
                },
                "Calvin": {
                    c: "#6495ED", loc: ROI.DMN, title: "The Geek", weight: "HIGH", fn: "Dissociation via narrative immersion.", region: "Default Mode",
                    str: { exec: 3, social: 3, creative: 8, resilience: 5, empathy: 5, humor: 5, physical: 1, intellect: 8 },
                    cln: { dissoc: 8, anxiety: 3, narcissism: 1, impulsivity: 2, rigidity: 2, avoidance: 6, shame: 2, hypervig: 1 }
                },
                "Brock": {
                    c: "#CD5C5C", loc: ROI.Motor_L, title: "The Gym Rat", weight: "MEDIUM", fn: "Muscle as armor. Somatic Shield.", region: "Motor Cortex",
                    str: { exec: 4, social: 5, creative: 2, resilience: 8, empathy: 2, humor: 4, physical: 10, intellect: 2 },
                    cln: { dissoc: 3, anxiety: 4, narcissism: 6, impulsivity: 6, rigidity: 5, avoidance: 2, shame: 3, hypervig: 4 }
                },
                "Brenda": {
                    c: "#882244", loc: ROI.Raphe, title: "The Resigned Hedonist", weight: "MEDIUM", fn: "Defense of Resignation. Post-apocalyptic state.", region: "Raphe Nuclei",
                    str: { exec: 2, social: 2, creative: 4, resilience: 5, empathy: 3, humor: 3, physical: 1, intellect: 4 },
                    cln: { dissoc: 5, anxiety: 4, narcissism: 2, impulsivity: 3, rigidity: 2, avoidance: 8, shame: 5, hypervig: 1 }
                },
                "Bobby": {
                    c: "#F0E68C", loc: ROI.Somato, title: "The Gentle Geriatric", weight: "MEDIUM", fn: "'Pain is just weather.' Somatic Acceptance.", region: "Somatosensory",
                    str: { exec: 2, social: 4, creative: 3, resilience: 8, empathy: 7, humor: 3, physical: 2, intellect: 3 },
                    cln: { dissoc: 5, anxiety: 2, narcissism: 0, impulsivity: 1, rigidity: 1, avoidance: 5, shame: 2, hypervig: 1 }
                },
                "Billy": {
                    c: "#F4A460", loc: ROI.Amygdala_L, title: "The Scapegoat", weight: "MEDIUM", fn: "Weaponized Incompetence. Decoy for criticism.", region: "L Amygdala",
                    str: { exec: 2, social: 5, creative: 3, resilience: 5, empathy: 4, humor: 5, physical: 3, intellect: 2 },
                    cln: { dissoc: 4, anxiety: 5, narcissism: 0, impulsivity: 4, rigidity: 1, avoidance: 4, shame: 7, hypervig: 3 }
                },
                "Becs": {
                    c: "#9370DB", loc: ROI.V1, title: "The Artist", weight: "MEDIUM", fn: "Aesthetic Dissociation. Stores image without pain.", region: "Primary Visual",
                    str: { exec: 2, social: 2, creative: 10, resilience: 5, empathy: 5, humor: 2, physical: 2, intellect: 5 },
                    cln: { dissoc: 6, anxiety: 3, narcissism: 1, impulsivity: 2, rigidity: 2, avoidance: 5, shame: 2, hypervig: 1 }
                },
                "Ario": {
                    c: "#AAFF00", loc: ROI.SMA, title: "The Sprinter", weight: "HIGH", fn: "Pre-Verbal Self. Movement and sign language.", region: "SMA",
                    str: { exec: 3, social: 5, creative: 5, resilience: 9, empathy: 4, humor: 4, physical: 10, intellect: 3 },
                    cln: { dissoc: 3, anxiety: 3, narcissism: 1, impulsivity: 8, rigidity: 1, avoidance: 1, shame: 1, hypervig: 3 }
                },
                "Anne Margarette": {
                    c: "#CCCCFF", loc: ROI.dACC, title: "The Iron Matriarch", weight: "MEDIUM-HIGH", fn: "Structure Holder. 'Discipline is freedom.'", region: "Dorsal ACC",
                    str: { exec: 9, social: 4, creative: 2, resilience: 8, empathy: 3, humor: 1, physical: 3, intellect: 6 },
                    cln: { dissoc: 2, anxiety: 5, narcissism: 3, impulsivity: 1, rigidity: 9, avoidance: 3, shame: 3, hypervig: 5 }
                },
                "Alexandru": {
                    c: "#6644AA", loc: ROI.STG, title: "The Sonic Dreamer", weight: "MEDIUM", fn: "Sonic Dissociation. Life needs a soundtrack.", region: "Sup. Temporal G.",
                    str: { exec: 2, social: 3, creative: 8, resilience: 5, empathy: 5, humor: 3, physical: 2, intellect: 4 },
                    cln: { dissoc: 7, anxiety: 3, narcissism: 2, impulsivity: 3, rigidity: 1, avoidance: 5, shame: 2, hypervig: 1 }
                },
                "Abdul": {
                    c: "#9932CC", loc: ROI.Rostral_PFC, title: "The Llama Baron", weight: "LOW", fn: "Trickster. Turns intrusion into elaborate games.", region: "Rostral PFC",
                    str: { exec: 4, social: 8, creative: 9, resilience: 5, empathy: 3, humor: 10, physical: 3, intellect: 5 },
                    cln: { dissoc: 4, anxiety: 1, narcissism: 5, impulsivity: 9, rigidity: 0, avoidance: 1, shame: 0, hypervig: 2 }
                },
                "A.B.S.": {
                    c: "#00FFCC", loc: ROI.Brainstem, title: "The Bio-Mechanic", weight: "HIGH", fn: "Somatic autopilot. Separates Self from Meat.", region: "Brainstem",
                    str: { exec: 6, social: 0, creative: 0, resilience: 10, empathy: 0, humor: 0, physical: 8, intellect: 3 },
                    cln: { dissoc: 10, anxiety: 0, narcissism: 0, impulsivity: 0, rigidity: 7, avoidance: 8, shame: 0, hypervig: 2 }
                },
                "Pierre": {
                    c: "#FF6347", loc: ROI.NucAcc, title: "The Spirit of Joy", weight: "MEDIUM", fn: "Joy Keeper. 'Just be a happy man dancing.'", region: "Nuc. Accumbens",
                    str: { exec: 3, social: 9, creative: 7, resilience: 5, empathy: 6, humor: 8, physical: 5, intellect: 3 },
                    cln: { dissoc: 3, anxiety: 1, narcissism: 3, impulsivity: 6, rigidity: 0, avoidance: 1, shame: 0, hypervig: 1 }
                },
                "Peter": {
                    c: "#FF4500", loc: ROI.Locus_C, title: "The Vitality Seeker", weight: "MEDIUM", fn: "Somatic Reset. Chases fear to feel alive.", region: "Locus Coeruleus",
                    str: { exec: 3, social: 5, creative: 4, resilience: 9, empathy: 3, humor: 4, physical: 9, intellect: 3 },
                    cln: { dissoc: 2, anxiety: 2, narcissism: 2, impulsivity: 10, rigidity: 1, avoidance: 0, shame: 0, hypervig: 5 }
                }
            };

            /* ═══ RELATIONSHIP DATA ═══ */
            var REL = {
                "Ethan": { allies: ["Janet", "The Mediator", "Joshua"], rivals: ["Frank", "Alexander", "Joey"] },
                "Synthia": { allies: ["Isabella", "Janet", "Anne Margarette"], rivals: ["Jabez", "Frank", "Brenda"] },
                "Alexander": { allies: ["Danny", "Brock", "Spencer"], rivals: ["Elder Repression", "Janet", "Collin"] },
                "The Watcher": { allies: ["Chogi Doshin", "Hypnosis", "The Mediator"], rivals: ["Alexander", "Danny", "Rylee"] },
                "Sleeper": { allies: ["A.B.S.", "Bobby", "Luke"], rivals: ["Danny", "Rylee", "Entertainer"] },
                "Rylee": { allies: ["Ario", "Peter", "Danny"], rivals: ["Elder Repression", "Synthia", "Anne Margarette"] },
                "Payne": { allies: ["Jabez", "Brenda", "The Watcher"], rivals: ["Alexander", "The Beginning", "Danny"] },
                "The Beginning": { allies: ["Keon", "Kyle", "Ms. Higgins"], rivals: ["Jabez", "John", "Frank"] },
                "Elder Repression": { allies: ["Synthia", "Anne Margarette", "Janet"], rivals: ["Frank", "Danny", "Alexander"] },
                "Janet": { allies: ["Ethan", "Synthia", "Anne Margarette"], rivals: ["Danny", "Rylee", "Entertainer"] },
                "Danny": { allies: ["Spencer", "Pierre", "Alexander"], rivals: ["Elder Repression", "Luke", "Janet"] },
                "The Mediator": { allies: ["Chogi Doshin", "The Watcher", "Ethan"], rivals: [] },
                "Kyle": { allies: ["The Beginning", "Ms. Higgins", "Enrique"], rivals: ["John", "Hank", "A.B.S."] },
                "Jabez": { allies: ["Payne", "Brenda"], rivals: ["The Beginning", "Pierre", "Chogi Doshin"] },
                "Nikolai": { allies: ["A.B.S.", "Joshua", "Brock"], rivals: ["Calvin", "Luke", "Pierre"] },
                "Vendilla": { allies: ["The Watcher", "Keon", "Explorer"], rivals: [] },
                "Luke": { allies: ["Hank", "Thomas", "Kane"], rivals: ["Alexander", "Danny", "Nikolai"] },
                "Tom": { allies: ["Jane Parker", "Ms. Higgins", "Kyle"], rivals: ["Hank", "Joey", "John"] },
                "Thomas": { allies: ["Luke", "Sequoia", "Chogi Doshin"], rivals: ["Ario", "Danny", "Nikolai"] },
                "Tanti": { allies: ["Explorer", "Ivan", "Keon"], rivals: ["Bobby", "Brenda", "Sleeper"] },
                "Spencer": { allies: ["Danny", "Entertainer", "Pierre"], rivals: ["John", "Elder Repression", "Hank"] },
                "Sequoia": { allies: ["Thomas", "Pierre", "Luke"], rivals: ["Elder Repression", "Synthia", "Janet"] },
                "Zen Master Roshi": { allies: ["Entertainer", "Chogi Doshin", "Frank"], rivals: ["Elder Repression", "Synthia"] },
                "Future": { allies: ["The Mediator", "Joshua", "Ethan"], rivals: ["Collin", "Brenda", "Jabez"] },
                "Ms. Higgins": { allies: ["The Beginning", "Kyle", "Tom"], rivals: ["John", "Nikolai"] },
                "Keon": { allies: ["The Beginning", "Calvin", "Vendilla"], rivals: ["Hank", "Nikolai"] },
                "Kane": { allies: ["Luke", "Hank", "Joshua"], rivals: ["Jabez", "Alexander"] },
                "Juan Carlos": { allies: ["Spencer", "Entertainer", "Enrique"], rivals: ["Elder Repression", "Cho", "Synthia"] },
                "Joshua": { allies: ["Ethan", "Nikolai", "Kane"], rivals: ["Jens", "Calvin"] },
                "John": { allies: ["Duke Rutherford", "Joey", "Kane"], rivals: ["Kyle", "The Beginning", "Billy"] },
                "Joey": { allies: ["John", "Frank", "Kane"], rivals: ["Jens", "Ethan", "Kyle"] },
                "Jens": { allies: ["Kyle", "Hypnosis", "Alexander"], rivals: ["Frank", "Hank", "John"] },
                "Jane Parker": { allies: ["Ms. Higgins", "Tom", "Francois"], rivals: ["Frank", "Nikolai"] },
                "Jameson": { allies: ["Brock", "Nikolai", "Hank"], rivals: ["Bobby", "Jens"] },
                "Ivan": { allies: ["Dr. Gretchen", "Duke Rutherford", "The Mediator"], rivals: ["Frank", "Rylee"] },
                "Isabella": { allies: ["Synthia", "Becs", "Hans"], rivals: ["Brenda", "Billy"] },
                "Hypnosis": { allies: ["Chogi Doshin", "The Watcher", "Kyle"], rivals: ["Frank", "Tanti"] },
                "Hank": { allies: ["Luke", "Kane", "Nikolai"], rivals: ["Danny", "Kyle", "Duane"] },
                "Hans": { allies: ["Isabella", "Alexander", "Brock"], rivals: ["Bobby", "Billy", "Brenda"] },
                "Dr. Gretchen": { allies: ["Ivan", "Duke Rutherford", "Janet"], rivals: ["Billy", "Frank", "Cho"] },
                "Frank": { allies: ["Joey", "Zen Master Roshi"], rivals: ["Elder Repression", "Jane Parker", "Jens"] },
                "Francois": { allies: ["Jane Parker", "Ms. Higgins"], rivals: ["Nikolai", "Sleeper"] },
                "Explorer": { allies: ["Tanti", "Brock", "Vendilla"], rivals: ["Sleeper", "Hank", "Payne"] },
                "Enrique": { allies: ["Kyle", "Isabella", "Juan Carlos"], rivals: ["Frank", "Rylee", "Elder Repression"] },
                "Entertainer": { allies: ["Abdul", "Danny", "Zen Master Roshi"], rivals: ["Hank", "Janet", "Sleeper"] },
                "Ean": { allies: ["Collin", "Jabez"], rivals: ["Elder Repression", "Kyle", "Hypnosis"] },
                "Duane": { allies: ["Danny", "Spencer", "Pierre"], rivals: ["Hank", "Elder Repression", "Jabez"] },
                "Duke Rutherford": { allies: ["John", "Dr. Gretchen", "Ivan"], rivals: ["Rylee", "Frank", "Collin"] },
                "Collin": { allies: ["Ean", "Synthia"], rivals: ["Chogi Doshin", "Hank", "Future"] },
                "Chogi Doshin": { allies: ["Hypnosis", "The Watcher", "The Mediator"], rivals: ["Jabez", "Elder Repression", "Frank"] },
                "Cho": { allies: ["Keon", "Thomas"], rivals: ["Dr. Gretchen", "Juan Carlos", "Charles"] },
                "Charlie": { allies: ["Abdul", "John"], rivals: ["Elder Repression", "Synthia", "Jane Parker"] },
                "Charles": { allies: ["Synthia", "Hans"], rivals: ["Charlie", "Frank", "Brenda"] },
                "Calvin": { allies: ["Keon", "Vendilla", "Alexandru"], rivals: ["Jabez", "Frank", "Brock"] },
                "Brock": { allies: ["Jameson", "Alexander", "Nikolai"], rivals: ["Hans", "Jens", "Elder Repression"] },
                "Brenda": { allies: ["Payne", "Jabez", "Hank"], rivals: ["Rylee", "The Beginning", "Janet"] },
                "Bobby": { allies: ["Ms. Higgins", "The Beginning", "Sleeper"], rivals: ["Nikolai", "Frank", "Joey"] },
                "Billy": { allies: ["Hank", "Joshua"], rivals: ["Dr. Gretchen", "Charles", "John"] },
                "Becs": { allies: ["Isabella", "Keon", "Vendilla"], rivals: ["Hank", "Nikolai", "Sleeper"] },
                "Ario": { allies: ["Rylee", "Peter", "Tanti"], rivals: ["Thomas", "Elder Repression", "Sleeper"] },
                "Anne Margarette": { allies: ["Synthia", "Janet", "Duke Rutherford"], rivals: ["Frank", "Rylee", "Brenda"] },
                "Alexandru": { allies: ["Calvin", "Jens", "Brock"], rivals: ["Nikolai", "Hank", "Sleeper"] },
                "Abdul": { allies: ["Entertainer", "Charlie", "The Beginning"], rivals: ["Synthia", "Elder Repression", "Hank"] },
                "A.B.S.": { allies: ["Sleeper", "Nikolai", "Explorer"], rivals: ["Kyle", "The Beginning", "Rylee"] },
                "Pierre": { allies: ["Danny", "Spencer", "Sequoia"], rivals: ["Elder Repression", "Nikolai", "Jabez"] },
                "Peter": { allies: ["Rylee", "Ario", "Kane"], rivals: ["Collin", "Sleeper", "Synthia"] }
            };

            /* ═══ TARGET ROIs — directed pathway destinations per alter ═══ */
            var TARGETS = {
                "Ethan": ["Broca", "OFC", "ACC", "Thalamus"],
                "Synthia": ["DLPFC_L", "dACC", "Striatum", "Insula_L"],
                "Alexander": ["VTA", "OFC", "Amygdala_L", "Motor_L"],
                "The Watcher": ["Precuneus", "DMN", "Thalamus", "V1"],
                "Sleeper": ["Brainstem", "Thalamus", "Raphe", "PAG"],
                "Rylee": ["SMA", "Cerebellum", "NucAcc", "Amygdala_R"],
                "Payne": ["Amygdala_L", "PAG", "Insula_L", "PCC"],
                "The Beginning": ["NucAcc", "Amygdala_L", "mPFC", "Hippo_L"],
                "Elder Repression": ["DLPFC_L", "OFC", "Amygdala_L", "PCC"],
                "Janet": ["DLPFC_R", "OFC", "Thalamus", "Striatum"],
                "Danny": ["VTA", "Motor_L", "STG", "Amygdala_L"],
                "The Mediator": ["ACC", "DLPFC_L", "Thalamus", "PCC"],
                "Kyle": ["Amygdala_L", "sgACC", "OFC", "Somato"],
                "Jabez": ["PAG", "Brainstem", "sgACC", "Amygdala_L"],
                "Nikolai": ["SMA", "Cerebellum", "Striatum", "Thalamus"],
                "Vendilla": ["Precuneus", "PCC", "DMN", "V1"],
                "Luke": ["Brainstem", "Raphe", "PAG", "Hippo_L"],
                "Tom": ["OFC", "Ant_Insula", "ACC", "Hippo_L"],
                "Thomas": ["Motor_L", "Hippo_L", "Cerebellum", "PCC"],
                "Tanti": ["Striatum", "Motor_L", "DLPFC_R", "NucAcc"],
                "Spencer": ["Wernicke", "NucAcc", "Ant_Insula", "OFC"],
                "Sequoia": ["NucAcc", "VTA", "Raphe", "Amygdala_L"],
                "Zen Master Roshi": ["Broca", "STG", "NucAcc", "mPFC"],
                "Future": ["DLPFC_L", "ACC", "Precuneus", "Thalamus"],
                "Ms. Higgins": ["Amygdala_L", "OFC", "Ant_Insula", "VMPFC"],
                "Keon": ["Precuneus", "Hippo_L", "DMN", "Broca"],
                "Kane": ["Amygdala_R", "PAG", "DLPFC_R", "Thalamus"],
                "Juan Carlos": ["Wernicke", "NucAcc", "Ant_Insula", "STG"],
                "Joshua": ["Motor_L", "NucAcc", "DLPFC_L", "Thalamus"],
                "John": ["Amygdala_R", "Brainstem", "DLPFC_R", "Locus_C"],
                "Joey": ["PAG", "Motor_R", "Striatum", "Locus_C"],
                "Jens": ["Amygdala_L", "Hippo_L", "sgACC", "Insula_L"],
                "Jane Parker": ["OFC", "Ant_Insula", "VMPFC", "Olfactory"],
                "Jameson": ["Motor_L", "Motor_R", "SMA", "Brainstem"],
                "Ivan": ["DLPFC_L", "Precuneus", "Wernicke", "PCC"],
                "Isabella": ["OFC", "EBA", "Ant_Insula", "DLPFC_L"],
                "Hypnosis": ["PCC", "PAG", "Raphe", "Insula_L"],
                "Hank": ["DLPFC_L", "ACC", "Striatum", "Motor_R"],
                "Hans": ["V1", "OFC", "Somato", "NucAcc"],
                "Dr. Gretchen": ["Broca", "Hippo_L", "Precuneus", "DLPFC_R"],
                "Frank": ["VTA", "NucAcc", "Motor_L", "Broca"],
                "Francois": ["Insula_L", "OFC", "Ant_Insula", "VMPFC"],
                "Explorer": ["Precuneus", "PCC", "DMN", "SPL"],
                "Enrique": ["Insula_L", "NucAcc", "VTA", "Ant_Insula"],
                "Entertainer": ["Broca", "NucAcc", "STG", "Ant_Insula"],
                "Ean": ["Amygdala_L", "sgACC", "PAG", "Raphe"],
                "Duane": ["Broca", "Wernicke", "NucAcc", "Ant_Insula"],
                "Duke Rutherford": ["DLPFC_L", "Precuneus", "Thalamus", "ACC"],
                "Collin": ["Amygdala_L", "sgACC", "DLPFC_L", "Hippo_L"],
                "Chogi Doshin": ["PCC", "DMN", "Insula_L", "ACC"],
                "Cho": ["Broca", "Hippo_L", "DLPFC_L", "sgACC"],
                "Charlie": ["Motor_L", "Striatum", "NucAcc", "DLPFC_L"],
                "Charles": ["OFC", "DLPFC_L", "Precuneus", "ACC"],
                "Calvin": ["PCC", "Precuneus", "Hippo_L", "V1"],
                "Brock": ["SMA", "Cerebellum", "NucAcc", "Striatum"],
                "Brenda": ["sgACC", "Amygdala_L", "PAG", "Insula_L"],
                "Bobby": ["Insula_L", "PAG", "Raphe", "PCC"],
                "Billy": ["sgACC", "OFC", "Insula_L", "Hippo_L"],
                "Becs": ["V4", "EBA", "Hippo_L", "PCC"],
                "Ario": ["Motor_L", "Cerebellum", "NucAcc", "Amygdala_L"],
                "Anne Margarette": ["DLPFC_L", "OFC", "Striatum", "ACC"],
                "Alexandru": ["Wernicke", "Hippo_L", "Insula_L", "V1"],
                "Abdul": ["Broca", "NucAcc", "mPFC", "STG"],
                "A.B.S.": ["PAG", "Thalamus", "Motor_R", "Raphe"],
                "Pierre": ["VTA", "STG", "Motor_L", "Broca"],
                "Peter": ["Amygdala_R", "Motor_L", "NucAcc", "PAG"]
            };

            // Scale ROI coordinates
            var rk = Object.keys(ROI); for (var ri = 0; ri < rk.length; ri++) { var r = ROI[rk[ri]]; r.y *= 0.6; r.z *= 0.9; r.x *= 1.1; }

            // Compute bounding radius from all ROI positions (for adaptive shell scaling)
            var maxROIRadius = 0;
            for (var ri2 = 0; ri2 < rk.length; ri2++) {
                var rr = ROI[rk[ri2]];
                var rd = Math.sqrt(rr.x * rr.x + rr.y * rr.y + rr.z * rr.z);
                if (rd > maxROIRadius) maxROIRadius = rd;
            }

            /* ═══════════════════════════════════════════
               THREE.JS SCENE
               ═══════════════════════════════════════════ */
            var scene, camera, renderer, brainGroup;
            var activeAlters = []; var VISUAL = {}; var expandedBio = null;

            var vp = document.getElementById('viewport');
            scene = new THREE.Scene(); scene.fog = new THREE.FogExp2(0x030508, 0.012);
            camera = new THREE.PerspectiveCamera(32, vp.clientWidth / vp.clientHeight, 0.1, 500);
            camera.position.set(0, 4, 48); camera.lookAt(0, 0, 0);
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(vp.clientWidth, vp.clientHeight); renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            vp.appendChild(renderer.domElement);
            scene.add(new THREE.AmbientLight(0x334466, 0.6));
            var kl = new THREE.SpotLight(0x00ccee, 2.0); kl.position.set(25, 40, 30); scene.add(kl);
            var fl2 = new THREE.SpotLight(0x4400aa, 0.8); fl2.position.set(-30, -15, 20); scene.add(fl2);
            brainGroup = new THREE.Group(); scene.add(brainGroup);

            /* ═══ BRAIN VOLUME ═══ */
            function isInBrain(x, y, z) {
                var o = 0.4, dx = x - o, dy = y - 0.5, dz = z;
                var iR = (dx * dx / 14.44 + dy * dy / 9 + dz * dz / 25) < 1;
                var dl = x + o; var iL = (dl * dl / 14.44 + dy * dy / 9 + dz * dz / 25) < 1;
                if (Math.abs(x) < 0.15 && y > 0.5) return false;
                var tx = x - 2.8, ty = y + 1.5, tz = z - 0.5; var iTR = (tx * tx / 3.24 + ty * ty / 2.25 + tz * tz / 6.25) < 1;
                var tl = x + 2.8; var iTL = (tl * tl / 3.24 + ty * ty / 2.25 + tz * tz / 6.25) < 1;
                var cx = x, cy = y + 2, cz = z + 3; var iCb = (cx * cx / 16 + cy * cy / 2.25 + cz * cz / 4) < 1;
                var sx = x, a = -0.3, sy2 = y + 2.5, sz2 = z + 0.5;
                var sy = sy2 * Math.cos(a) - sz2 * Math.sin(a); var sz = sy2 * Math.sin(a) + sz2 * Math.cos(a);
                var iSt = (sx * sx + sz * sz) < 0.8 && sy > -3.5 && sy < 1;
                return iR || iL || iTR || iTL || iCb || iSt;
            }

            // Point cloud
            var bg = new THREE.BufferGeometry(); var bp = [], bc = [];
            for (var i = 0; i < 100000; i++) { var x = (Math.random() - 0.5) * 16, y = (Math.random() - 0.5) * 16, z = (Math.random() - 0.5) * 16; if (isInBrain(x, y, z)) { var n = Math.sin(x * 5) * Math.cos(y * 4) * Math.sin(z * 3.5); x += n * 0.06; y += n * 0.06; z += n * 0.06; bp.push(x, y, z); var d = (x * x + y * y + z * z) / 40, b = 1 - Math.min(d, 0.75), ry = (y + 6) / 12; bc.push(0.35 * b + ry * 0.15, 0.5 * b + ry * 0.1, 0.75 * b); } }
            bg.setAttribute('position', new THREE.Float32BufferAttribute(bp, 3)); bg.setAttribute('color', new THREE.Float32BufferAttribute(bc, 3));
            var cloudMat = new THREE.PointsMaterial({ size: 0.05, vertexColors: true, transparent: true, opacity: 0.85, blending: THREE.AdditiveBlending, depthWrite: false });
            brainGroup.add(new THREE.Points(bg, cloudMat));

            /* ═══ TRANSPARENT BRAIN SHELL (STL LOADER) ═══ */
            var brainShellGroup = new THREE.Group();
            brainGroup.add(brainShellGroup);
            var shellLoaded = false;

            // Shell materials
            var shellMat = new THREE.MeshPhongMaterial({
                color: '#8899bb',
                transparent: true,
                opacity: 0.12,
                side: THREE.DoubleSide,
                depthWrite: false,
                shininess: 80,
                specular: new THREE.Color('#556688')
            });
            var wireMat = new THREE.MeshBasicMaterial({
                color: '#4488aa',
                wireframe: true,
                transparent: true,
                opacity: 0.025,
                depthWrite: false
            });
            brainShellGroup.userData.shellMat = shellMat;
            brainShellGroup.userData.wireMat = wireMat;

            function loadSTLGeometry(buffer) {
                // Parse STL
                var loader = new THREE.STLLoader();
                var geometry = loader.parse(buffer);
                geometry.computeBoundingBox();
                var bb = geometry.boundingBox;

                // Center the geometry
                var cx = (bb.min.x + bb.max.x) / 2;
                var cy = (bb.min.y + bb.max.y) / 2;
                var cz = (bb.min.z + bb.max.z) / 2;
                geometry.translate(-cx, -cy, -cz);

                // Scale to fit the actual ROI bounding sphere adaptively
                var maxDim = Math.max(bb.max.x - bb.min.x, bb.max.y - bb.min.y, bb.max.z - bb.min.z);
                // Adaptive: shell diameter = 2 * (max ROI radius + pathway extension padding)
                var targetSize = (maxROIRadius + 1.2) * 2;
                var scale = targetSize / maxDim;
                geometry.scale(scale, scale, scale);

                // The STL Y-axis is typically "up" in modeling software
                // but in our scene Y is up as well. The STL Z may be forward.
                // Rotate so the brain frontal lobe faces +Z (forward in our scene)
                // and brainstem faces -Y (down)
                // Standard STL brain: Y=anterior-posterior, Z=superior-inferior
                // We need: Z=anterior(front), Y=superior(up), X=lateral
                geometry.rotateX(-Math.PI / 2); // swap Y/Z: Z-up becomes Y-up

                geometry.computeVertexNormals();

                // Clear previous shell meshes
                while (brainShellGroup.children.length > 0) {
                    brainShellGroup.remove(brainShellGroup.children[0]);
                }

                // Solid transparent mesh
                var shellMesh = new THREE.Mesh(geometry, shellMat);
                shellMesh.renderOrder = -1;
                brainShellGroup.add(shellMesh);

                // Wireframe overlay
                var wireMesh = new THREE.Mesh(geometry, wireMat);
                wireMesh.renderOrder = -1;
                brainShellGroup.add(wireMesh);

                shellLoaded = true;
                shellState = 0;
                shellBtn.textContent = 'Shell: On';
                shellBtn.className = 'vp-btn state-on';
                brainShellGroup.visible = true;

                // Update status
                document.getElementById('vp-bl').innerText = 'STL loaded (' + (geometry.attributes.position.count / 3 | 0) + ' tris)';
            }

            // File input + drag-and-drop
            var stlInput = document.getElementById('stl-file-input');
            var dropOverlay = document.getElementById('stl-drop-overlay');

            function handleSTLFile(file) {
                if (!file) return;
                var reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        loadSTLGeometry(e.target.result);
                    } catch (err) {
                        var errEl = document.getElementById('error-display');
                        errEl.style.display = 'block';
                        errEl.innerHTML = 'STL Load Error: ' + err.message;
                    }
                };
                reader.readAsArrayBuffer(file);
            }

            stlInput.addEventListener('change', function (e) {
                handleSTLFile(e.target.files[0]);
            });

            // Drag and drop on viewport
            vp.addEventListener('dragenter', function (e) {
                e.preventDefault();
                dropOverlay.classList.add('show');
            });
            vp.addEventListener('dragover', function (e) {
                e.preventDefault();
            });
            vp.addEventListener('dragleave', function (e) {
                if (e.relatedTarget && vp.contains(e.relatedTarget)) return;
                dropOverlay.classList.remove('show');
            });
            vp.addEventListener('drop', function (e) {
                e.preventDefault();
                dropOverlay.classList.remove('show');
                var files = e.dataTransfer.files;
                for (var fi = 0; fi < files.length; fi++) {
                    if (files[fi].name.toLowerCase().endsWith('.stl')) {
                        handleSTLFile(files[fi]);
                        break;
                    }
                }
            });

            /* ═══ AUTO-FETCH STL FROM URL ═══ */
            var shellState = -1; // -1 = not loaded
            var shellBtn = document.getElementById('shell-toggle');
            var loadOverlay = document.getElementById('stl-loading-overlay');
            var loadBar = document.getElementById('load-bar');
            (function autoFetchSTL() {
                if (!STL_URL || STL_URL.indexOf('USER/REPO') !== -1) {
                    // Placeholder URL — hide spinner, show drag-drop prompt
                    loadOverlay.classList.add('hidden');
                    shellBtn.textContent = 'Shell: Load';
                    shellBtn.className = 'vp-btn';
                    return;
                }
                var xhr = new XMLHttpRequest();
                xhr.open('GET', STL_URL, true);
                xhr.responseType = 'arraybuffer';
                xhr.onprogress = function (e) {
                    if (e.lengthComputable) {
                        var pct = Math.round((e.loaded / e.total) * 100);
                        loadBar.style.width = pct + '%';
                    }
                };
                xhr.onload = function () {
                    if (xhr.status === 200) {
                        loadBar.style.width = '100%';
                        try {
                            var buf = xhr.response;
                            // Decompress if gzipped
                            if (STL_URL.indexOf('.gz') === STL_URL.length - 3 && typeof pako !== 'undefined') {
                                buf = pako.inflate(new Uint8Array(buf)).buffer;
                            }
                            loadSTLGeometry(buf);
                        } catch (err) {
                            document.getElementById('error-display').style.display = 'block';
                            document.getElementById('error-display').innerHTML = 'STL Parse Error: ' + err.message;
                        }
                    } else {
                        shellBtn.textContent = 'Shell: Load';
                        shellBtn.className = 'vp-btn';
                    }
                    setTimeout(function () { loadOverlay.classList.add('hidden'); }, 400);
                };
                xhr.onerror = function () {
                    loadOverlay.classList.add('hidden');
                    shellBtn.textContent = 'Shell: Load';
                    shellBtn.className = 'vp-btn';
                };
                xhr.send();
            })();

            // Shell toggle / load button
            shellBtn.addEventListener('click', function () {
                if (!shellLoaded) {
                    // Open file picker
                    stlInput.click();
                    return;
                }
                shellState = (shellState + 1) % 3;
                var sm = brainShellGroup.userData.shellMat;
                var wm = brainShellGroup.userData.wireMat;
                if (shellState === 0) {
                    brainShellGroup.visible = true;
                    sm.opacity = 0.12; wm.opacity = 0.025;
                    shellBtn.textContent = 'Shell: On';
                    shellBtn.className = 'vp-btn state-on';
                } else if (shellState === 1) {
                    brainShellGroup.visible = true;
                    sm.opacity = 0.05; wm.opacity = 0.012;
                    shellBtn.textContent = 'Shell: Dim';
                    shellBtn.className = 'vp-btn state-dim';
                } else {
                    brainShellGroup.visible = false;
                    shellBtn.textContent = 'Shell: Off';
                    shellBtn.className = 'vp-btn';
                }
            });

            /* ═══ BRIGHTNESS SLIDERS ═══ */
            var shellSlider = document.getElementById('shell-brightness');
            var cloudSlider = document.getElementById('cloud-brightness');
            var shellBrightVal = document.getElementById('shell-bright-val');
            var cloudBrightVal = document.getElementById('cloud-bright-val');

            shellSlider.addEventListener('input', function () {
                var v = parseInt(this.value);
                shellBrightVal.textContent = v;
                if (shellLoaded && shellState !== 2) {
                    shellMat.opacity = (v / 100) * 0.25;
                    wireMat.opacity = (v / 100) * 0.05;
                }
            });
            cloudSlider.addEventListener('input', function () {
                var v = parseInt(this.value);
                cloudBrightVal.textContent = v;
                cloudMat.opacity = v / 100;
            });

            /* ═══ CONNECTION LINES (Ally/Rival) ═══ */
            var connectionGroup = new THREE.Group();
            brainGroup.add(connectionGroup);

            function buildConnections() {
                // Clear old connections
                while (connectionGroup.children.length > 0) {
                    var ch = connectionGroup.children[0];
                    if (ch.geometry) ch.geometry.dispose();
                    if (ch.material) ch.material.dispose();
                    connectionGroup.remove(ch);
                }
                if (activeAlters.length < 2) return;

                var drawn = {};
                for (var i = 0; i < activeAlters.length; i++) {
                    var nameA = activeAlters[i];
                    var relA = REL[nameA];
                    if (!relA) continue;
                    var posA = VISUAL[nameA] ? VISUAL[nameA].userData.hubPos : null;
                    if (!posA) continue;

                    for (var j = i + 1; j < activeAlters.length; j++) {
                        var nameB = activeAlters[j];
                        var posB = VISUAL[nameB] ? VISUAL[nameB].userData.hubPos : null;
                        if (!posB) continue;

                        var key = nameA + '|' + nameB;
                        if (drawn[key]) continue;
                        drawn[key] = true;

                        var isAlly = relA.allies && relA.allies.indexOf(nameB) !== -1;
                        var isRival = relA.rivals && relA.rivals.indexOf(nameB) !== -1;

                        // Check reverse direction too
                        var relB = REL[nameB];
                        if (!isAlly && relB && relB.allies && relB.allies.indexOf(nameA) !== -1) isAlly = true;
                        if (!isRival && relB && relB.rivals && relB.rivals.indexOf(nameA) !== -1) isRival = true;

                        if (!isAlly && !isRival) continue;

                        // Create curved line with a midpoint arc
                        var mid = new THREE.Vector3().lerpVectors(posA, posB, 0.5);
                        var dist = posA.distanceTo(posB);
                        // Offset midpoint perpendicular to the line for a slight arc
                        var dir = new THREE.Vector3().subVectors(posB, posA).normalize();
                        var up = new THREE.Vector3(0, 1, 0);
                        var perp = new THREE.Vector3().crossVectors(dir, up).normalize();
                        mid.add(perp.multiplyScalar(dist * 0.15));
                        mid.y += dist * 0.1;

                        var curve = new THREE.QuadraticBezierCurve3(posA, mid, posB);
                        var pts = curve.getPoints(20);
                        var lineGeo = new THREE.BufferGeometry().setFromPoints(pts);

                        if (isAlly) {
                            // Cyan ally bond
                            var colorA = new THREE.Color(DB[nameA].c);
                            var colorB = new THREE.Color(DB[nameB].c);
                            var blendColor = colorA.clone().lerp(colorB, 0.5);
                            var lineMat = new THREE.LineBasicMaterial({
                                color: blendColor,
                                transparent: true,
                                opacity: 0.35,
                                blending: THREE.AdditiveBlending
                            });
                            connectionGroup.add(new THREE.Line(lineGeo, lineMat));
                        }
                        if (isRival) {
                            // Red rival tension
                            var rivalMat = new THREE.LineDashedMaterial({
                                color: 0xff3333,
                                transparent: true,
                                opacity: 0.2,
                                dashSize: 0.3,
                                gapSize: 0.2,
                                blending: THREE.AdditiveBlending
                            });
                            var rivalLine = new THREE.Line(lineGeo.clone(), rivalMat);
                            rivalLine.computeLineDistances();
                            connectionGroup.add(rivalLine);
                        }
                    }
                }
            }

            function clampBrain(t) { if (isInBrain(t.x, t.y, t.z)) return t; var a = new THREE.Vector3(0, 0, 0), b2 = t.clone(), m = new THREE.Vector3(); for (var i = 0; i < 12; i++) { m.lerpVectors(a, b2, 0.5); if (isInBrain(m.x, m.y, m.z)) a.copy(m); else b2.copy(m); } return a; }

            /* ═══ ALTER MESH ═══ */
            function makeAlter(name, rank) {
                var d = DB[name], c = d.c, g = new THREE.Group();
                var pos = clampBrain(new THREE.Vector3(d.loc.x, d.loc.y, d.loc.z));
                var ln, sn, gl, op;
                if (rank === 0) { ln = 400; sn = 24; gl = 1.4; op = 1; }
                else if (rank === 1) { ln = 200; sn = 14; gl = 0.9; op = 1; }
                else { ln = 100; sn = 6; gl = 0.6; op = Math.max(0.5, 1 - (rank - 1) * 0.06); }
                // Per-alter style from clinical profile
                var cln = d.cln || {};
                var isExec = (d.str && d.str.exec >= 7);
                var isEmotional = (cln.anxiety >= 6 || cln.shame >= 6);
                var isDissoc = (cln.dissoc >= 7);
                var isMotor = (d.str && d.str.physical >= 8);
                var wanderAmt = 0.5, segLen = 0.55, branchProb = 0.15, gapProb = 0;
                if (isExec) { wanderAmt = 0.3; segLen = 0.7; branchProb = 0.08; }
                if (isEmotional) { wanderAmt = 0.8; segLen = 0.35; branchProb = 0.22; ln = Math.round(ln * 1.3); }
                if (isDissoc) { wanderAmt = 0.4; segLen = 0.45; branchProb = 0.1; gapProb = 0.12; ln = Math.round(ln * 0.7); }
                if (isMotor) { wanderAmt = 0.25; segLen = 0.65; branchProb = 0.06; }
                var hub = new THREE.Mesh(new THREE.SphereGeometry(0.35, 16, 16), new THREE.MeshBasicMaterial({ color: c, transparent: true, opacity: op }));
                hub.position.copy(pos);
                hub.add(new THREE.Mesh(new THREE.SphereGeometry(gl, 16, 16), new THREE.MeshBasicMaterial({ color: c, transparent: true, opacity: op * 0.35, blending: THREE.AdditiveBlending })));
                if (rank === 0) hub.add(new THREE.Mesh(new THREE.SphereGeometry(2, 16, 16), new THREE.MeshBasicMaterial({ color: c, transparent: true, opacity: 0.08, blending: THREE.AdditiveBlending })));
                g.add(hub); g.userData = { paths: [], pulses: [], pulseTimer: 0, rank: rank, color: new THREE.Color(c), hubPos: pos };
                // Resolve target positions
                var tgtKeys = TARGETS[name] || [];
                var tgtPositions = [];
                for (var ti = 0; ti < tgtKeys.length; ti++) { var tr = ROI[tgtKeys[ti]]; if (tr) tgtPositions.push(new THREE.Vector3(tr.x, tr.y, tr.z)); }
                var pts = [], cols = [], subN = [], tc = new THREE.Color(c);
                var directedRatio = tgtPositions.length > 0 ? 0.4 : 0;
                function addPathSegs(path) { for (var k = 0; k < path.length - 1; k++) { pts.push(path[k].x, path[k].y, path[k].z, path[k + 1].x, path[k + 1].y, path[k + 1].z); var a2 = op * (0.7 - k / 14); cols.push(tc.r, tc.g, tc.b, Math.max(0.05, a2), tc.r, tc.g, tc.b, Math.max(0.02, a2 - 0.1)); } }
                for (var i = 0; i < ln; i++) {
                    var cur = pos.clone();
                    var isDir = (Math.random() < directedRatio && tgtPositions.length > 0);
                    var tgtP = isDir ? tgtPositions[Math.floor(Math.random() * tgtPositions.length)] : null;
                    var dir;
                    if (isDir) {
                        dir = tgtP.clone().sub(pos).normalize();
                        dir.x += (Math.random() - 0.5) * 0.3; dir.y += (Math.random() - 0.5) * 0.3; dir.z += (Math.random() - 0.5) * 0.3; dir.normalize();
                    } else { dir = new THREE.Vector3(Math.random() - 0.5, Math.random() - 0.5, Math.random() - 0.5).normalize(); }
                    var segs = 10 + Math.floor(Math.random() * 6); var lp = [cur.clone()]; var didBranch = false;
                    for (var s = 0; s < segs; s++) {
                        dir.x += (Math.random() - 0.5) * wanderAmt; dir.y += (Math.random() - 0.5) * wanderAmt; dir.z += (Math.random() - 0.5) * wanderAmt;
                        if (isDir && tgtP) { var toT = tgtP.clone().sub(cur).normalize(); dir.x += toT.x * 0.35; dir.y += toT.y * 0.35; dir.z += toT.z * 0.35; }
                        dir.normalize();
                        if (gapProb > 0 && Math.random() < gapProb && s > 2 && s < segs - 2) {
                            if (lp.length > 1) { g.userData.paths.push(lp); addPathSegs(lp); }
                            cur = cur.clone().add(dir.clone().multiplyScalar(segLen * 2)); lp = [cur.clone()]; continue;
                        }
                        var nx = cur.clone().add(dir.clone().multiplyScalar(segLen));
                        if (isInBrain(nx.x, nx.y, nx.z)) {
                            cur.copy(nx); lp.push(cur.clone());
                            if (!didBranch && s > 3 && Math.random() < branchProb) {
                                didBranch = true;
                                var bD = new THREE.Vector3(dir.y + (Math.random() - 0.5), -dir.x + (Math.random() - 0.5), dir.z + (Math.random() - 0.5)).normalize();
                                var bC = cur.clone(); var bP = [bC.clone()];
                                for (var bs = 0; bs < 4 + Math.floor(Math.random() * 4); bs++) {
                                    bD.x += (Math.random() - 0.5) * 0.6; bD.y += (Math.random() - 0.5) * 0.6; bD.z += (Math.random() - 0.5) * 0.6; bD.normalize();
                                    var bnx = bC.clone().add(bD.clone().multiplyScalar(segLen * 0.7));
                                    if (isInBrain(bnx.x, bnx.y, bnx.z)) { bC.copy(bnx); bP.push(bC.clone()); } else break;
                                }
                                if (bP.length > 1) { g.userData.paths.push(bP); addPathSegs(bP); if (subN.length < sn) subN.push(bC.clone()); }
                            }
                            if (s >= segs - 2 && subN.length < sn && Math.random() > 0.5) subN.push(cur.clone());
                        } else break;
                    }
                    if (lp.length > 1) { g.userData.paths.push(lp); addPathSegs(lp); }
                }
                if (pts.length > 0) { var lg = new THREE.BufferGeometry(); lg.setAttribute('position', new THREE.Float32BufferAttribute(pts, 3)); lg.setAttribute('color', new THREE.Float32BufferAttribute(cols, 4)); g.add(new THREE.LineSegments(lg, new THREE.LineBasicMaterial({ color: c, transparent: true, opacity: op * 0.8, blending: THREE.AdditiveBlending }))); }
                var sg = new THREE.SphereGeometry(0.08, 6, 6), sm2 = new THREE.MeshBasicMaterial({ color: c, transparent: true, opacity: op * 0.5 }); for (var j = 0; j < subN.length; j++) { var m2 = new THREE.Mesh(sg, sm2); m2.position.copy(subN[j]); g.add(m2); }
                brainGroup.add(g); VISUAL[name] = g;
            }
            function rebuild() { var ks = Object.keys(VISUAL); for (var i = 0; i < ks.length; i++) { brainGroup.remove(VISUAL[ks[i]]); delete VISUAL[ks[i]]; } for (var j = 0; j < activeAlters.length; j++)makeAlter(activeAlters[j], j); buildConnections(); }

            /* ═══════════════════════════════════════════
               SYSTEM MIX CALCULATION
               ═══════════════════════════════════════════ */
            function calcSystemMix() {
                if (!activeAlters.length) return null;
                var strTotals = {}, clnTotals = {};
                var si2, ki2;
                for (si2 = 0; si2 < STR_KEYS.length; si2++) { strTotals[STR_KEYS[si2]] = 0; }
                for (si2 = 0; si2 < CLN_KEYS.length; si2++) { clnTotals[CLN_KEYS[si2]] = 0; }
                var totalWeight = 0;
                for (var ai = 0; ai < activeAlters.length; ai++) {
                    var d = DB[activeAlters[ai]];
                    var w = ai === 0 ? 1.0 : (ai === 1 ? 0.65 : 0.30);
                    totalWeight += w;
                    for (ki2 = 0; ki2 < STR_KEYS.length; ki2++) { strTotals[STR_KEYS[ki2]] += d.str[STR_KEYS[ki2]] * w; }
                    for (ki2 = 0; ki2 < CLN_KEYS.length; ki2++) { clnTotals[CLN_KEYS[ki2]] += d.cln[CLN_KEYS[ki2]] * w; }
                }
                // Normalize to 0-10 scale
                for (ki2 = 0; ki2 < STR_KEYS.length; ki2++) { strTotals[STR_KEYS[ki2]] = Math.round(strTotals[STR_KEYS[ki2]] / totalWeight * 10) / 10; }
                for (ki2 = 0; ki2 < CLN_KEYS.length; ki2++) { clnTotals[CLN_KEYS[ki2]] = Math.round(clnTotals[CLN_KEYS[ki2]] / totalWeight * 10) / 10; }
                // Find dominant strength and risk
                var topStr = '', topStrVal = 0, topCln = '', topClnVal = 0;
                for (ki2 = 0; ki2 < STR_KEYS.length; ki2++) { if (strTotals[STR_KEYS[ki2]] > topStrVal) { topStrVal = strTotals[STR_KEYS[ki2]]; topStr = STR_LABELS[ki2]; } }
                for (ki2 = 0; ki2 < CLN_KEYS.length; ki2++) { if (clnTotals[CLN_KEYS[ki2]] > topClnVal) { topClnVal = clnTotals[CLN_KEYS[ki2]]; topCln = CLN_LABELS[ki2]; } }
                return { str: strTotals, cln: clnTotals, topStr: topStr, topStrVal: topStrVal, topCln: topCln, topClnVal: topClnVal };
            }

            /* ═══════════════════════════════════════════
               UI UPDATE
               ═══════════════════════════════════════════ */
            function updateUI() {
                var list = document.getElementById('hierarchy-list'), readout = document.getElementById('neural-readout');
                var mE = document.getElementById('v-mode'), sE = document.getElementById('v-strength'), rE = document.getElementById('v-risk'), cE = document.getElementById('v-coh');
                var st = document.getElementById('vp-bl'), mixEl = document.getElementById('system-mix');
                document.getElementById('active-count').innerText = activeAlters.length + ' Active';
                if (!activeAlters.length) {
                    list.innerHTML = '<div class="empty-hint"><span style="display:block;font-size:28px;margin-bottom:10px;opacity:0.3">&#9671;</span>Search and inject an alter<br><small style="color:#2a3444">Drag to rotate · Scroll to zoom</small></div>';
                    mE.innerText = '—'; mE.className = 'c-val v-neut'; sE.innerText = '—'; sE.className = 'c-val v-neut'; rE.innerText = '—'; rE.className = 'c-val v-neut'; cE.innerText = '—'; cE.className = 'c-val v-neut';
                    readout.innerHTML = '<span style="color:#3a4656">Awaiting alter injection…</span>';
                    mixEl.innerHTML = '<span style="color:#3a4656;font-size:10px">Inject alters to see combined trait analysis</span>';
                    st.innerText = 'Idle'; return;
                }

                // Build hierarchy
                var h = '';
                for (var i = 0; i < activeAlters.length; i++) {
                    var n2 = activeAlters[i], d = DB[n2], id = n2.replace(/[\s.\-\'\"]/g, '_');
                    var cc = i === 0 ? 'driver' : (i === 1 ? 'passenger' : 'backseat');
                    var bc2 = i === 0 ? 'b-driver' : (i === 1 ? 'b-pass' : 'b-back');
                    var rn = i === 0 ? 'DRIVER' : (i === 1 ? 'PASS' : 'BACK');
                    var op2 = i <= 1 ? 100 : Math.round(Math.max(50, (1 - (i - 1) * 0.06)) * 100);

                    // Per-alter score bars
                    var scoreHtml = '<div class="score-divider" style="color:#00e5ff">Strengths</div>';
                    for (var si3 = 0; si3 < STR_KEYS.length; si3++) {
                        var sv = d.str[STR_KEYS[si3]];
                        scoreHtml += '<div class="score-row"><div class="score-label">' + STR_LABELS[si3] + '</div><div class="score-track"><div class="score-fill" style="width:' + sv * 10 + '%;background:' + STR_COLORS[si3] + '"></div></div><div class="score-val">' + sv + '</div></div>';
                    }
                    scoreHtml += '<div class="score-divider" style="color:#ff7043">Clinical Shadow</div>';
                    for (var ci2 = 0; ci2 < CLN_KEYS.length; ci2++) {
                        var cv = d.cln[CLN_KEYS[ci2]];
                        scoreHtml += '<div class="score-row"><div class="score-label">' + CLN_LABELS[ci2] + '</div><div class="score-track"><div class="score-fill" style="width:' + cv * 10 + '%;background:' + CLN_COLORS[ci2] + '"></div></div><div class="score-val">' + cv + '</div></div>';
                    }

                    var btns = '';
                    if (i > 0) btns += '<button class="h-btn" data-action="up" data-idx="' + i + '">&#9650;</button>';
                    if (i < activeAlters.length - 1) btns += '<button class="h-btn" data-action="down" data-idx="' + i + '">&#9660;</button>';
                    btns += '<button class="h-btn del" data-action="rem" data-name="' + n2 + '">&#10005;</button>';

                    h += '<div class="h-card ' + cc + '" data-toggle="' + id + '">';
                    h += '<div class="h-left"><div class="h-badge ' + bc2 + '">' + rn + '</div><div class="h-info">';
                    h += '<div class="h-name" style="color:' + d.c + '">' + n2 + '</div>';
                    h += '<div class="h-title">' + d.title + '</div>';
                    h += '<div class="h-meta">' + d.weight + ' · ' + op2 + '%</div>';
                    h += '</div></div><div class="h-btns">' + btns + '</div></div>';
                    h += '<div class="h-bio" id="bio_' + id + '"><span class="bio-lbl">Function</span><span class="bio-val">' + d.fn + '</span>';
                    h += '<span class="bio-lbl">Neural Locus</span><span class="bio-accent">' + d.region + '</span>';
                    h += '<div class="score-section">' + scoreHtml + '</div></div>';
                }
                list.innerHTML = h;

                // Events
                var cards = list.querySelectorAll('.h-card');
                for (var ci3 = 0; ci3 < cards.length; ci3++) { cards[ci3].addEventListener('click', function (e) { if (e.target.closest('.h-btns')) return; var tid = 'bio_' + this.getAttribute('data-toggle'), el = document.getElementById(tid); if (!el) return; if (expandedBio && expandedBio !== tid) { var p = document.getElementById(expandedBio); if (p) p.classList.remove('open'); } el.classList.toggle('open'); expandedBio = el.classList.contains('open') ? tid : null; }); }
                var allBtns = list.querySelectorAll('.h-btn');
                for (var bi = 0; bi < allBtns.length; bi++) { allBtns[bi].addEventListener('click', function (e) { e.stopPropagation(); var act = this.getAttribute('data-action'); if (act === 'rem') { activeAlters = activeAlters.filter(function (a) { return a !== this.getAttribute('data-name'); }.bind(this)); expandedBio = null; rebuild(); updateUI(); } else if (act === 'up') { var idx = parseInt(this.getAttribute('data-idx')); if (idx > 0) { var t = activeAlters[idx - 1]; activeAlters[idx - 1] = activeAlters[idx]; activeAlters[idx] = t; rebuild(); updateUI(); } } else if (act === 'down') { var idx2 = parseInt(this.getAttribute('data-idx')); if (idx2 < activeAlters.length - 1) { var t2 = activeAlters[idx2 + 1]; activeAlters[idx2 + 1] = activeAlters[idx2]; activeAlters[idx2] = t2; rebuild(); updateUI(); } } }); }

                // Console - Driver State
                var mix = calcSystemMix();
                if (mix) {
                    var dr = DB[activeAlters[0]], ds = dr.cln;
                    var mode;
                    if (ds.dissoc >= 8) mode = 'DISSOCIATED'; else if (ds.impulsivity >= 8) mode = 'IMPULSIVE'; else if (ds.anxiety >= 8) mode = 'ANXIOUS'; else if (ds.narcissism >= 7) mode = 'GRANDIOSE'; else if (ds.shame >= 7) mode = 'SHAME-DRIVEN'; else if (ds.rigidity >= 8) mode = 'RIGID'; else if (ds.avoidance >= 7) mode = 'WITHDRAWN'; else mode = 'BALANCED';
                    mE.innerText = mode; var mc = { 'BALANCED': 'v-good', 'DISSOCIATED': 'v-crit', 'IMPULSIVE': 'v-warn', 'ANXIOUS': 'v-warn', 'GRANDIOSE': 'v-warn', 'SHAME-DRIVEN': 'v-crit', 'RIGID': 'v-warn', 'WITHDRAWN': 'v-neut' }; mE.className = 'c-val ' + (mc[mode] || 'v-neut');

                    sE.innerText = mix.topStr.toUpperCase(); sE.className = 'c-val v-accent';
                    rE.innerText = mix.topCln.toUpperCase(); rE.className = 'c-val ' + (mix.topClnVal > 7 ? 'v-crit' : (mix.topClnVal > 4 ? 'v-warn' : 'v-good'));

                    if (activeAlters.length === 1) { cE.innerText = 'SINGULAR'; cE.className = 'c-val v-good'; }
                    else { var vs = []; for (var vi = 0; vi < activeAlters.length; vi++)vs.push(DB[activeAlters[vi]].cln.dissoc); var mn = 0; for (var mi = 0; mi < vs.length; mi++)mn += vs[mi]; mn /= vs.length; var va = 0; for (var vi2 = 0; vi2 < vs.length; vi2++)va += (vs[vi2] - mn) * (vs[vi2] - mn); va /= vs.length; if (va > 15) { cE.innerText = 'FRACTURED'; cE.className = 'c-val v-crit'; } else if (va > 8) { cE.innerText = 'STRAINED'; cE.className = 'c-val v-warn'; } else { cE.innerText = 'COHERENT'; cE.className = 'c-val v-good'; } }

                    // System Mix Panel
                    var mh = '<div class="mix-category">Combined Strengths</div>';
                    for (var ms2 = 0; ms2 < STR_KEYS.length; ms2++) {
                        var val = mix.str[STR_KEYS[ms2]];
                        var clr = STR_COLORS[ms2];
                        mh += '<div class="mix-row"><div class="mix-label" style="color:' + clr + '">' + STR_LABELS[ms2] + '</div><div class="mix-track"><div class="mix-fill" style="width:' + val * 10 + '%;background:' + clr + '"></div></div><div class="mix-val" style="color:' + clr + '">' + val + '</div></div>';
                    }
                    mh += '<div class="mix-category">Combined Clinical Risks</div>';
                    for (var mc2 = 0; mc2 < CLN_KEYS.length; mc2++) {
                        var val2 = mix.cln[CLN_KEYS[mc2]];
                        var clr2 = CLN_COLORS[mc2];
                        mh += '<div class="mix-row"><div class="mix-label" style="color:' + clr2 + '">' + CLN_LABELS[mc2] + '</div><div class="mix-track"><div class="mix-fill" style="width:' + val2 * 10 + '%;background:' + clr2 + '"></div></div><div class="mix-val" style="color:' + clr2 + '">' + val2 + '</div></div>';
                    }

                    // Insight box
                    var insight = '';
                    if (mix.topStrVal >= 7) insight += '<b>Dominant asset:</b> ' + mix.topStr + ' (' + mix.topStrVal + '/10). ';
                    if (mix.topClnVal >= 6) insight += '<b>Watch for:</b> ' + mix.topCln + ' tendencies (' + mix.topClnVal + '/10). ';
                    if (activeAlters.length >= 3) {
                        // Check for interesting combos
                        if (mix.str.social >= 7 && mix.cln.impulsivity >= 6) insight += 'High social + high impulsivity = charismatic but risky. ';
                        if (mix.str.resilience >= 7 && mix.cln.dissoc >= 6) insight += 'Strong resilience paired with dissociation — enduring by leaving. ';
                        if (mix.str.empathy >= 7 && mix.cln.shame >= 5) insight += 'Deep empathy + shame = absorbing others\' pain as own. ';
                        if (mix.str.intellect >= 7 && mix.cln.avoidance >= 5) insight += 'Intellectual strength with avoidance — understanding without feeling. ';
                        if (mix.str.humor >= 7 && mix.cln.anxiety >= 4) insight += 'Comedy as anxiety armor — watch for deflection. ';
                        if (mix.str.creative >= 7 && mix.cln.dissoc >= 5) insight += 'Creative dissociation — making beauty from distance. ';
                        if (mix.str.physical >= 7 && mix.cln.rigidity >= 5) insight += 'Body-focused + rigidity = control through physicality. ';
                        if (mix.str.exec >= 7 && mix.cln.rigidity >= 6) insight += 'Executive + rigid = productive but brittle under chaos. ';
                    }
                    if (insight) { mh += '<div class="mix-highlight"><div class="mix-highlight-title">System Insight</div><div class="mix-highlight-text">' + insight + '</div></div>'; }

                    mixEl.innerHTML = mh;
                }

                // Neural readout
                var rh2 = '', lim = Math.min(activeAlters.length, 4), roles = ['PRIMARY', 'SECONDARY', 'TERTIARY', 'QUATERNARY'];
                for (var rri = 0; rri < lim; rri++) { var rd = DB[activeAlters[rri]]; rh2 += '<div style="margin-bottom:3px"><span style="color:' + rd.c + ';font-weight:600">' + activeAlters[rri] + '</span> <span style="color:#3a4656;font-size:9px">[' + roles[rri] + '] ' + rd.loc.label + '</span></div>'; }
                if (activeAlters.length > 4) rh2 += '<div style="color:#3a4656;font-size:9px;margin-top:3px">+ ' + (activeAlters.length - 4) + ' backseat</div>';

                // Show active relationships
                if (activeAlters.length >= 2) {
                    var allyPairs = [], rivalPairs = [];
                    for (var ri2 = 0; ri2 < activeAlters.length; ri2++) {
                        for (var rj = ri2 + 1; rj < activeAlters.length; rj++) {
                            var nA = activeAlters[ri2], nB = activeAlters[rj];
                            var rA = REL[nA], rB = REL[nB];
                            var ally = (rA && rA.allies && rA.allies.indexOf(nB) !== -1) || (rB && rB.allies && rB.allies.indexOf(nA) !== -1);
                            var rival = (rA && rA.rivals && rA.rivals.indexOf(nB) !== -1) || (rB && rB.rivals && rB.rivals.indexOf(nA) !== -1);
                            if (ally) allyPairs.push('<div class="rel-bond">⚡ ' + nA + ' ↔ ' + nB + ' <span style="color:#3a4656">(allies)</span></div>');
                            if (rival) rivalPairs.push('<div class="rel-rival">⚠ ' + nA + ' ↔ ' + nB + ' <span style="color:#3a4656">(rivals)</span></div>');
                        }
                    }
                    if (allyPairs.length || rivalPairs.length) {
                        rh2 += '<div class="rel-section">Active Bonds</div>';
                        rh2 += allyPairs.join('');
                        if (rivalPairs.length) {
                            rh2 += '<div class="rel-section">Tensions</div>';
                            rh2 += rivalPairs.join('');
                        }
                    }
                }

                readout.innerHTML = rh2; st.innerText = activeAlters[0] + ' driving';
            }

            /* ═══ SEARCH ═══ */
            var allN = Object.keys(DB).sort(), sI = document.getElementById('search-input'), dd = document.getElementById('alter-dropdown');
            function renderDD(f) { if (!f) { dd.classList.remove('show'); return; } var fl = f.toLowerCase(), ms = allN.filter(function (n) { return n.toLowerCase().indexOf(fl) !== -1 || DB[n].title.toLowerCase().indexOf(fl) !== -1; }); if (!ms.length) { dd.classList.remove('show'); return; } var h2 = ''; for (var i = 0; i < ms.length; i++) { var n = ms[i], d = DB[n], u = activeAlters.indexOf(n) !== -1; h2 += '<div class="dd-item' + (u ? ' used' : '') + '" data-inject="' + n + '"><div class="dd-left"><span class="dd-dot" style="background:' + d.c + '"></span><span>' + n + '</span></div><span class="dd-weight">' + d.weight + '</span></div>'; } dd.innerHTML = h2; dd.classList.add('show'); var items = dd.querySelectorAll('.dd-item:not(.used)'); for (var j = 0; j < items.length; j++) { items[j].addEventListener('click', function () { var nm = this.getAttribute('data-inject'); if (activeAlters.length < 10 && activeAlters.indexOf(nm) === -1) { activeAlters.push(nm); rebuild(); updateUI(); } sI.value = ''; dd.classList.remove('show'); }); } }
            sI.addEventListener('input', function () { renderDD(this.value.trim()); });
            sI.addEventListener('focus', function () { if (this.value.trim()) renderDD(this.value.trim()); });
            document.addEventListener('click', function (e) { if (!e.target.closest('#search-input') && !e.target.closest('#alter-dropdown')) dd.classList.remove('show'); });

            /* ═══ INTERACTION ═══ */
            var isDrag = false, pM = { x: 0, y: 0 }, pinchDist = 0;
            document.getElementById('reset-view').addEventListener('click', function () { brainGroup.rotation.set(0, 0, 0); camera.position.set(0, 4, 48); camera.lookAt(0, 0, 0); });
            vp.addEventListener('mousedown', function (e) { if (e.button === 0) { isDrag = true; pM = { x: e.clientX, y: e.clientY }; } });
            document.addEventListener('mouseup', function () { isDrag = false; });
            document.addEventListener('mousemove', function (e) { if (isDrag) { brainGroup.rotation.y += (e.clientX - pM.x) * 0.005; brainGroup.rotation.x += (e.clientY - pM.y) * 0.005; pM = { x: e.clientX, y: e.clientY }; } });
            vp.addEventListener('touchstart', function (e) { e.preventDefault(); if (e.touches.length === 1) { isDrag = true; pM = { x: e.touches[0].clientX, y: e.touches[0].clientY }; } if (e.touches.length === 2) { isDrag = false; pinchDist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY); } }, { passive: false });
            vp.addEventListener('touchmove', function (e) { e.preventDefault(); if (e.touches.length === 2 && pinchDist) { var nd = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY); camera.position.z = Math.max(5, Math.min(100, camera.position.z - (nd - pinchDist) * 0.08)); pinchDist = nd; } else if (isDrag && e.touches.length === 1) { brainGroup.rotation.y += (e.touches[0].clientX - pM.x) * 0.008; brainGroup.rotation.x += (e.touches[0].clientY - pM.y) * 0.008; pM = { x: e.touches[0].clientX, y: e.touches[0].clientY }; } }, { passive: false });
            document.addEventListener('touchend', function () { isDrag = false; pinchDist = 0; });
            vp.addEventListener('wheel', function (e) { camera.position.z = Math.max(5, Math.min(100, camera.position.z + e.deltaY * 0.04)); });
            window.addEventListener('resize', function () { camera.aspect = vp.clientWidth / vp.clientHeight; camera.updateProjectionMatrix(); renderer.setSize(vp.clientWidth, vp.clientHeight); });

            /* ═══ PULSES ═══ */
            var pGeo = new THREE.SphereGeometry(0.06, 4, 4);
            function updatePulses() { var ks = Object.keys(VISUAL); for (var ki = 0; ki < ks.length; ki++) { var g = VISUAL[ks[ki]], ud = g.userData; if (!ud.paths || !ud.paths.length) continue; var sr = Math.floor(4 * Math.pow(2, Math.min(ud.rank, 4))); ud.pulseTimer++; if (ud.pulseTimer >= sr) { ud.pulseTimer = 0; var pi = Math.floor(Math.random() * ud.paths.length); var pm = new THREE.MeshBasicMaterial({ color: ud.color, transparent: true, opacity: 0.9, blending: THREE.AdditiveBlending }); var mesh = new THREE.Mesh(pGeo, pm); g.add(mesh); ud.pulses.push({ mesh: mesh, pathIdx: pi, nodeIdx: 0, progress: 0 }); } for (var pj = ud.pulses.length - 1; pj >= 0; pj--) { var p = ud.pulses[pj], path = ud.paths[p.pathIdx]; p.progress += 0.18; if (p.progress >= 1) { p.progress = 0; p.nodeIdx++; } if (p.nodeIdx >= path.length - 1) { g.remove(p.mesh); p.mesh.material.dispose(); ud.pulses.splice(pj, 1); } else { p.mesh.position.lerpVectors(path[p.nodeIdx], path[p.nodeIdx + 1], p.progress); p.mesh.material.opacity = 0.9 * (1 - p.nodeIdx / (path.length - 1) * 0.7); } } } }

            /* ═══ ANIMATE ═══ */
            var frame = 0;
            function animate() { requestAnimationFrame(animate); frame++; if (!isDrag) brainGroup.rotation.y += 0.0015; if (activeAlters.length > 0 && VISUAL[activeAlters[0]]) { var dh = VISUAL[activeAlters[0]].children[0]; if (dh) { var br = 1 + Math.sin(frame * 0.03) * 0.08; dh.scale.set(br, br, br); } } updatePulses(); renderer.render(scene, camera); }
            animate();

        })();
    </script>
</body>

</html>


